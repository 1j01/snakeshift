<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Snakeshift</title>
  <!-- <link rel="stylesheet" type="text/css" href="./index.css" /> -->
  <!-- <link rel="icon" type="image/png" href="/yin-yang-smol-sneks-128px.png" sizes="128x128" /> -->
  <link rel="icon" type="image/png" href="/yin-yang-larger-sneks-180px.png" sizes="180x180" />
</head>

<body>

  <div id="debug-console" style="
    position: absolute;
    top: 0;
    left: 80px;
    right: 0;
    max-height: 100vh;
    overflow-y: auto;
    z-index: 1000;
    background-color: white;
    border: 1px solid black;
    color: black;
  ">
    <h3>Debug Console</h3>
    <pre id="debug-output" style="
      overflow-y: auto;
      background-color: white;
      border: 1px solid black;
      color: black;
      margin: 5px;
      min-height: 100px;
    ">
    </pre>
    <b>&gt;</b> <textarea type="text" id="debug-input" style="width: 90%;"></textarea>
  </div>
  <script>
    // Notes on Kindle 4.x browser:
    // - `const` is supported but may be treated like `var`
    // - `let` is not supported
    // - `for...of` is not supported
    // - `Array.from` and/or `Array.prototype.map` and/or `Array.prototype.join` is not supported
    // - `JSON` is not supported (I've tried to include a polyfill with @vitejs/plugin-legacy, but that's not working, maybe because this is just a script tag and not a module?)
    // - `{variableAsKey}` is not supported
    // - Canvas is supported

    const originalConsole = window.console
    window.console = {}

    function logOnPage(message) {
      const pre = document.getElementById('debug-output')
      const div = document.createElement('div')
      div.textContent = message
      pre.appendChild(div)
    }
    function logEverywhere(a, b, c, d) {
      // Format message
      //const message = Array.from(arguments).join(' ')
      //const args = new Array(arguments.length).map(i => arguments[i])
      //const message = args.join(' ')
      var message = ''
      for (var i = 0; i < arguments.length; i++) {
        message += arguments[i]
        if (i < arguments.length - 1) {
          message += ' '
        }
      }
      // Log on page
      logOnPage(message)
      // Log on devtools console
      try {
        const method = "log"
        originalConsole[method].apply(originalConsole, arguments)
      } catch (e) {
        logOnPage(e)
      }
      // Log on server
      try {
        const xhr = new XMLHttpRequest()
        xhr.open('POST', '/log', true)
        //xhr.setRequestHeader('Content-Type', 'application/json')
        xhr.setRequestHeader('Content-Type', 'text/plain')
        xhr.onreadystatechange = function () {
          if (xhr.readyState === 4) {
            if (xhr.status !== 200) {
              logOnPage('Failed to log on server: ' + xhr.status + ' ' + xhr.statusText + ' ' + xhr.responseText)
            }
          }
        }
        //xhr.send(JSON.stringify({ message: message }))
        xhr.send(message)
      } catch (e) {
        logOnPage(e)
      }
    }

    //const methods = ['log', 'warn', 'error', 'debug', 'info', 'trace']
    //for (var i = 0; i < methods.length; i++) {
    //  const method = methods[i]

    console.log = logEverywhere
    console.warn = logEverywhere
    console.error = logEverywhere
    console.debug = logEverywhere
    console.info = logEverywhere
    console.trace = logEverywhere

    console.log("This is a log message")
    console.warn("This is a warning message")
    console.log("eval('1 + 1') is", eval('1 + 1'))
    console.log("window.addEventListener", window.addEventListener)
    console.log("window.onerror", window.onerror)

    //const methods = ['log', 'warn', 'error', 'debug', 'info', 'trace', 'table', 'group', 'groupCollapsed', 'groupEnd', 'time', 'timeEnd', 'timeLog', 'count', 'assert', 'clear', 'dir', 'dirxml', 'profile', 'profileEnd', 'timeStamp', 'context', 'memory', 'exception', 'table', 'group', 'groupCollapsed', 'groupEnd', 'time', 'timeEnd', 'timeLog', 'count', 'assert', 'clear', 'dir', 'dirxml']
    //for (var i = 0; i < methods.length; i++) {
    //  const method = methods[i]
    //  console.log(method)//, 'is', console[method] === originalConsole[method] ? 'the same as' : 'different from', 'original console.')
    //}
    try {
      const method = 'log'
      console.log(method, 'is', console[method] === originalConsole[method] ? 'the same as' : 'different from', 'original console.')
    } catch (e) {
      console.error(e)
    }

    function handleCommand(code) {
      console.log(">", code)
      try {
        const result = eval(code)
        console.log("<", result)
      } catch (e) {
        console.error(e)
      }
    }

    function sendCommand(code) {
      const xhr = new XMLHttpRequest()
      xhr.open('POST', '/command', true)
      xhr.setRequestHeader('Content-Type', 'text/plain')
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          if (xhr.status !== 200) {
            logOnPage('Failed to send command to server: ' + xhr.status + ' ' + xhr.statusText + ' ' + xhr.responseText)
          }
        }
      }
      xhr.send(code)
    }

    var receivingCommands = true
    function receiveCommand(code) {
      if (!receivingCommands) {
        return
      }

      const xhr = new XMLHttpRequest()
      xhr.open('GET', '/get-command', true)
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          if (xhr.status === 200) {
            const code = xhr.responseText
            if (code) {
              handleCommand(code)
            }
          } else {
            logOnPage('Failed to receive command from server: ' + xhr.status + ' ' + xhr.statusText + ' ' + xhr.responseText)
          }
        }
      }
      xhr.send()
    }
    setInterval(receiveCommand, 1000)

    const input = document.getElementById('debug-input')
    input.addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        const code = input.value
        handleCommand(code)
        receivingCommands = false
        sendCommand(code)
      }
    })
  </script>
  <button onclick="location.reload()" autofocus style="
    position: absolute;
    top: 0;
    left: 0;
    z-index: 1000;
    ">Reload</button>

  <blockquote id="tao-te-ching-quote" style="display: none;">
    <h2>
      Tao Te Ching — Lao Tzu — Chapter 11
    </h2>
    Thirty spokes share the wheel's hub;<br>
    It is the center hole that makes it useful.<br>
    Shape clay into a vessel;<br>
    It is the space within that makes it useful.<br>
    Cut doors and windows for a room;<br>
    It is the holes which make it useful.<br>
    Therefore profit comes from what is there;<br>
    Usefulness from what is not there.
  </blockquote>
  <div class="screen" id="main-menu">
    <h1>Snakeshift</h1>
    <button class="bw-button" id="play-button">Play</button>
    <button class="bw-button" id="level-select-button">Level Select</button>
    <button class="bw-button" id="level-editor-button">Level Editor</button>
    <button class="bw-button" id="credits-button">Credits</button>
  </div>
  <div class="screen" id="credits">
    <h1>Credits</h1>
    <p>
      <a href="https://isaiahodhner.io">Isaiah Odhner</a> — Programming, Design, Art
    </p>
  </div>
  <div class="screen" id="level-select">
    <h2>Level Select</h2>
    <div id="level-list">
      <h3>Easy</h3>
      <button class="bw-button level-button" data-level="/levels/easy/unlevel.json">
        Just Move
      </button>
      <button class="bw-button level-button" data-level="/levels/easy/lock-and-key.json">
        Bridge
      </button>
      <button class="bw-button level-button" data-level="/levels/easy/bridge-out-of-multiple-snakes.json">
        Ferry
      </button>
      <button class="bw-button level-button" data-level="/levels/easy/proper-lock.json">
        Lock
      </button>
      <button class="bw-button level-button" data-level="/levels/easy/yin-yang-give-and-take.json">
        Yin and Yang: Give and Take
      </button>
      <h3>Hard</h3>
      <button class="bw-button level-button" data-level="/levels/relatively-hard/yin-yang-full.json">
        Yin and Yang: Challenge
      </button>
      <button class="bw-button level-button" data-level="/levels/relatively-hard/security-by-obscurity-lock.json">
        Security by Obscurity
      </button>
      <div style="opacity: 0.5">
        <h3>Test Cases</h3>
        <button class="bw-button level-button" data-level="/levels/tests/possible-bug-unable-to-move-left.json">
          Possible bug: unable to move left here?
        </button>
        <button class="bw-button level-button"
          data-level="/levels/tests/possible-bug-why-is-it-detecting-this-as-invalid.json">
          Possible bug: why is it detecting this as invalid?
        </button>
        <button class="bw-button level-button" data-level="/levels/tests/format-version-too-new.json">
          EMIT Format version too new (Error Message Itself Test)
        </button>
      </div>
    </div>
  </div>
  <!-- TODO: make class an id or use a second button to better integrate with the entities bar -->
  <button class="bw-button back-to-main-menu-button">Back</button>
  <div id="level-editor">
    <div id="entities-bar">
      <button class="bw-button tool-button entity-button" data-entity="Snake" data-color="White">Snake (White)</button>
      <button class="bw-button tool-button entity-button" data-entity="Snake" data-color="Black">Snake (Black)</button>
      <button class="bw-button tool-button entity-button" data-entity="Collectable" data-color="White">Food
        (White)</button>
      <button class="bw-button tool-button entity-button" data-entity="Collectable" data-color="Black">Food
        (Black)</button>
      <button class="bw-button tool-button entity-button" data-entity="Crate" data-color="White">Crate (White)</button>
      <button class="bw-button tool-button entity-button" data-entity="Crate" data-color="Black">Crate (Black)</button>
      <button class="bw-button tool-button entity-button" data-entity="Block" data-color="White">Wall (White)</button>
      <button class="bw-button tool-button entity-button" data-entity="Block" data-color="Black">Wall (Black)</button>
      <!-- entity buttons are brush tools -->
      <!-- <button class="bw-button tool-button" data-tool="Brush">Brush</button> -->
      <button class="bw-button tool-button" data-tool="Eraser">
        <img src="/eraser.svg" />
        Erase
      </button>
      <button class="bw-button tool-button" data-tool="Move">
        <img src="/move.svg" />
        Move
      </button>
      <button class="bw-button" id="clear-button">
        <img src="/trash.svg" />
        Clear
      </button>
    </div>
    <!-- <div id="toolbar">
      <button id="play-button">Play</button>
      <button id="save-button">Save</button>
      <button id="load-button">Load</button>
      <button id="clear-button">Clear</button>
      <button id="undo-button">Undo</button>
      <button id="redo-button">Redo</button>
    </div> -->
    <script type="module" src="./main.ts"></script>
</body>

</html>
