System.register([],(function(e,t){"use strict";return{execute:function(){var e=document.createElement("style");e.textContent='html,body{margin:0;padding:0;height:100%;width:100%;overflow:hidden}body{background-color:#000;color:#fff;font-family:sans-serif}.hover-effect{position:absolute;border:5px solid yellow;border-radius:5px;box-sizing:border-box;pointer-events:none;transform:scale(1.1)}.hover-effect.active-effect{transform:scale(1)}.hover-effect.selection{transform:scale(1);border:none;outline:3px dashed white;mix-blend-mode:difference}.hover-effect:not(.valid){border:5px solid red}#tao-te-ching-quote footer{margin-top:2em}#tao-te-ching-quote{transform:skew(10deg)}#tao-te-ching-quote>*{transform:skew(-10deg)}#tao-te-ching-quote .line-b{margin-left:1em}#entities-bar,#replay-bar{position:absolute;top:0;z-index:2;width:100%;display:flex;overflow:auto;box-sizing:border-box;padding:5px;gap:5px;transition:transform .5s,opacity .5s}body:not(.editing) #entities-bar{transform:translateY(-100%);opacity:0}body:not(.replaying) #replay-bar{transform:translateY(-100%);opacity:0}#replay-slider{width:100%;height:40px}input{accent-color:#fff}input[type=checkbox]{-webkit-appearance:none;appearance:none;background-color:#000;margin:0;font:inherit;color:currentColor;width:1.15em;height:1.15em;border:.15em solid currentColor;border-radius:.15em;transform:translateY(-.075em);display:grid;place-content:center}input[type=checkbox]:before{content:"";width:.65em;height:.65em;transform:scale(0);transition:.12s transform ease-in-out;box-shadow:inset 1em 1em 0 currentColor;transform-origin:bottom left;clip-path:polygon(14% 44%,0 65%,50% 100%,100% 16%,80% 0%,43% 62%)}input[type=checkbox]:checked:before{transform:scale(1)}input[type=checkbox]:focus{outline:max(2px,.15em) solid currentColor;outline-offset:max(2px,.15em)}*::selection{background-color:#fff;color:#000}input::selection,.logo-shift::selection{background-color:#000;color:#fff}.control-row{display:flex;margin:5px 0;gap:5px;align-items:center}@media (max-width: 450px){:root dialog{margin:0;width:100vw;max-width:100vw}.control-row:not(.checkbox-control-row):not(.buttons-control-row){flex-direction:column;align-items:flex-start}}@media not (max-width: 450px){#level-info-editor .control-row label{width:130px;display:inline-block}#level-info-editor .control-row input,#level-info-editor .control-row textarea{width:200px}#settings-dialog .control-row label{width:235px;display:inline-block}}#settings-dialog fieldset{border:1px solid #fff;border-radius:5px;padding:15px;margin:15px 0}.fieldset-description{font-size:.8em;max-width:300px}.disabled{color:#aaa}.control-row input[type=number]{width:50px}.bw-button:not([hidden]){display:flex;align-items:center;justify-content:center;flex-direction:column;background-color:#000;color:#fff;border:2px solid #fff;border-radius:5px;padding:5px 10px;cursor:pointer;user-select:none}.bw-button:active{border-color:transparent;box-shadow:0 0 0 2px #fff inset}.bw-button.selected{background-color:#fff;color:#000}.bw-button:not(.selected) img{filter:invert()}.level-border{position:absolute;pointer-events:none;border:30px solid #fff;border-image:url('+new URL("../graphics/border-2.png",t.meta.url).href+') 46.875% round;border-image-outset:9px;image-rendering:pixelated;box-sizing:border-box}#credits a:link,#credits a:visited{color:#fff;font-weight:700}.level-preview{position:relative}.level-preview-error:not([hidden]){position:absolute;top:0;left:0;right:0;bottom:0;background-color:rgba(255,0,0,.5);display:flex;align-items:center;justify-content:center}#main-menu button,#level-select .level-button{min-height:50px;margin:10px;overflow:hidden}#main-menu button{position:relative}@media (min-width: 200px){#main-menu button img{position:absolute;left:10px}}#level-select,#credits{padding-top:70px;box-sizing:border-box}#level-list{text-align:center;max-width:900px}.level-button-wrapper,#level-select .level-button{display:inline-flex;position:relative}#level-select .level-button canvas{max-width:calc(100vw - 26px);max-height:calc(100vw - 26px)}.replay-button{position:absolute;right:0;top:0}#level-select .level-button[data-completed=true]:after,#level-select .level-button[data-completed=true]:before{content:"âœ¦";pointer-events:none;position:absolute;top:0;left:0;right:0;bottom:0;display:flex;align-items:center;justify-content:center;transform:translate(50%,-50%) translate(-2rem,2rem);font-size:5em;color:#fff;z-index:2}#level-select .level-button[data-completed=true]:before{font-size:6.7em;color:#000;z-index:1}#main-menu h1{font-size:min(2em,15vw)}#main-menu h1 .logo-shift{color:#000;background:#fff;border-radius:20px 30px/10px 0;padding:4px}#main-menu main{flex:1;display:flex;flex-direction:column;align-items:center;box-sizing:border-box;width:100%}.safe-center{padding-block:10px}.safe-center>*:first-child{margin-block-start:auto!important}.safe-center>*:last-child{margin-block-end:auto!important}#main-menu button{width:200px;max-width:calc(100% - 10px)}button:focus,a:focus{outline:5px solid white}a:focus{outline-offset:5px}a{color:inherit}footer{flex:0 0 50px;display:flex;align-items:center;justify-content:center;flex-wrap:wrap;text-align:center}:root dialog{border:30px solid #fff;border-image:url('+new URL("../graphics/border-2.png",t.meta.url).href+') 46.875% round;image-rendering:pixelated;background-color:#000;color:#fff;padding:min(16px,1vw);box-sizing:border-box}dialog>h2{margin-top:0}dialog button{min-width:80px;min-height:40px}#game-options-bar{position:absolute;top:0;left:0;right:0;padding:5px;box-sizing:border-box;z-index:3;flex-direction:row;gap:5px;display:flex;width:100%;overflow:auto}#game-options-bar .bw-button{padding:5px 0;flex:1;max-width:100px}body:not([data-standalone-level]) .hide-in-campaign{display:none}body[data-screen=level-select] .level-flow-control-button,body[data-screen=credits] .level-flow-control-button,.editing #restart-level-button{display:none}:fullscreen #fullscreen-button{display:none}@media (max-width: 600px){#game-options-bar .button-text{display:none}}#main-menu{z-index:4}.screen{display:flex;flex-direction:column;align-items:center;overflow:auto;position:absolute;top:0;left:0;width:100%;height:100%;z-index:2;background-color:#000;color:#fff}.screen:not(.active){display:none}#level-splash{pointer-events:none}.level-specific-overlay:not([hidden]),#level-stuck-hint:not([hidden]){position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;pointer-events:none;color:#fff;mix-blend-mode:difference;font-size:min(3vh,3vw);display:flex;flex-direction:column;align-items:center}.level-specific-overlay{padding-top:min(6vh,6vw)}.level-specific-overlay big{font-size:2em;display:inline-block;vertical-align:sub}#level-stuck-hint{bottom:10px;top:auto!important;height:auto!important;animation:fade-in 1s;animation-delay:1s;animation-fill-mode:both}@keyframes fade-in{0%{opacity:0}to{opacity:1}}.hint{margin-bottom:15px}kbd:not(.grouping-kbd){display:inline-block;padding:3px 5px;font-family:SFMono-Regular,Consolas,Liberation Mono,Menlo,monospace;font-size:.8em;line-height:10px;color:#fff;vertical-align:middle;background-color:#000;border:2px solid #fefbf0;border-radius:6px;box-shadow:2px 2px #fff,1px 1px #fff;margin-right:2px;text-shadow:none}[data-control-scheme=KeyboardAbsoluteDirection] .pointer-only,[data-control-scheme=KeyboardFacingRelative] .pointer-only,[data-control-scheme=Gamepad] .pointer-only,[data-control-scheme=Pointer] .keyboard-only,[data-control-scheme=Gamepad] .keyboard-only,[data-control-scheme=Pointer] .gamepad-only,[data-control-scheme=KeyboardAbsoluteDirection] .gamepad-only,[data-control-scheme=KeyboardFacingRelative] .gamepad-only{display:none}.gong-effect{overflow:hidden;position:absolute;top:0;left:0;width:100%;height:100%}.gong-effect:before{content:"";position:absolute;top:50%;left:50%;width:max(100vw,100vh);height:max(100vw,100vh);border-radius:50%;border:10px solid #fff;box-sizing:content-box;transform:translate(-50%,-50%);animation:gong 1s ease forwards}#game-win-screen.active .gong-effect:before{animation-duration:8s;animation-delay:-.5s}@keyframes gong{0%{transform:translate(-50%,-50%) scale(.3);border-width:10px}to{transform:translate(-50%,-50%) scale(sqrt(2));border-width:0}}[data-score]:after{content:"Score: " attr(data-score);font-size:1.5em}dialog{position:absolute;left:0;right:0;width:-moz-fit-content;width:-webkit-fit-content;width:fit-content;height:-moz-fit-content;height:-webkit-fit-content;height:fit-content;margin:auto;border:solid;padding:1em;background:#fff;color:#000;display:block}dialog:not([open]){display:none}dialog+.backdrop{position:fixed;top:0;right:0;bottom:0;left:0;background:rgba(0,0,0,.1)}._dialog_overlay{position:fixed;top:0;right:0;bottom:0;left:0}dialog.fixed{position:fixed;top:50%;transform:translateY(-50%)}\n/*$vite$:1*/',document.head.appendChild(e);const n=new class{memoryStorage=(()=>new Map)();setItem(e,t){this.memoryStorage.set(e,String(t));try{return localStorage.setItem(e,t),!0}catch(n){return console.warn("Failed to persist data to localStorage",n),!1}}getItem(e){try{return localStorage.getItem(e)}catch(t){return console.warn("Failed to retrieve data from localStorage",t),this.memoryStorage.get(e)??null}}removeItem(e){this.memoryStorage.delete(e);try{return localStorage.removeItem(e),!0}catch(t){return console.warn("Failed to remove data from localStorage",t),!1}}clear(){this.memoryStorage.clear();try{return localStorage.clear(),!0}catch(e){return console.warn("Failed to clear localStorage",e),!1}}};class i{constructor(e){this.selfOptions=e||{},this.pipes={}}options(e){return e&&(this.selfOptions=e),this.selfOptions}pipe(e,t){let n=t;if("string"==typeof e){if(void 0===n)return this.pipes[e];this.pipes[e]=n}if(e&&e.name){if(n=e,n.processor===this)return n;this.pipes[n.name]=n}return n.processor=this,n}process(e,t){let n=e;n.options=this.options();let i,o=t||e.pipe||"default";for(;o;)void 0!==n.nextAfterChildren&&(n.next=n.nextAfterChildren,n.nextAfterChildren=null),"string"==typeof o&&(o=this.pipe(o)),o.process(n),i=o,o=null,n&&n.next&&(n=n.next,o=n.pipe||i);return n.hasResult?n.result:void 0}}class o{constructor(e){this.name=e,this.filters=[]}process(e){if(!this.processor)throw new Error("add this pipe to a processor before using it");const t=this.debug,n=this.filters.length,i=e;for(let o=0;o<n;o++){const e=this.filters[o];if(t&&this.log(`filter: ${e.filterName}`),e(i),"object"==typeof i&&i.exiting){i.exiting=!1;break}}!i.next&&this.resultCheck&&this.resultCheck(i)}log(e){console.log(`[jsondiffpatch] ${this.name} pipe, ${e}`)}append(...e){return this.filters.push(...e),this}prepend(...e){return this.filters.unshift(...e),this}indexOf(e){if(!e)throw new Error("a filter name is required");for(let t=0;t<this.filters.length;t++)if(this.filters[t].filterName===e)return t;throw new Error(`filter not found: ${e}`)}list(){return this.filters.map((e=>e.filterName))}after(e,...t){const n=this.indexOf(e);return this.filters.splice(n+1,0,...t),this}before(e,...t){const n=this.indexOf(e);return this.filters.splice(n,0,...t),this}replace(e,...t){const n=this.indexOf(e);return this.filters.splice(n,1,...t),this}remove(e){const t=this.indexOf(e);return this.filters.splice(t,1),this}clear(){return this.filters.length=0,this}shouldHaveResult(e){if(!1!==e){if(!this.resultCheck)return this.resultCheck=e=>{if(!e.hasResult){console.log(e);const t=new Error(`${this.name} failed`);throw t.noResult=!0,t}},this}else this.resultCheck=null}}class s{setResult(e){return this.result=e,this.hasResult=!0,this}exit(){return this.exiting=!0,this}push(e,t){return e.parent=this,void 0!==t&&(e.childName=t),e.root=this.root||this,e.options=e.options||this.options,this.children?(this.children[this.children.length-1].next=e,this.children.push(e)):(this.children=[e],this.nextAfterChildren=this.next||null,this.next=e),e.next=this,this}}function r(e){if("object"!=typeof e)return e;if(null===e)return null;if(Array.isArray(e))return e.map(r);if(e instanceof Date)return new Date(e.getTime());if(e instanceof RegExp)return function(e){const t=/^\/(.*)\/([gimyu]*)$/.exec(e.toString());return new RegExp(t[1],t[2])}(e);const t={};for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(t[n]=r(e[n]));return t}class a extends s{constructor(e,t){super(),this.left=e,this.right=t,this.pipe="diff"}setResult(e){if(this.options.cloneDiffValues&&"object"==typeof e){const t="function"==typeof this.options.cloneDiffValues?this.options.cloneDiffValues:r;"object"==typeof e[0]&&(e[0]=t(e[0])),"object"==typeof e[1]&&(e[1]=t(e[1]))}return super.setResult(e)}}class l extends s{constructor(e,t){super(),this.left=e,this.delta=t,this.pipe="patch"}}class c extends s{constructor(e){super(),this.delta=e,this.pipe="reverse"}}const d=function(e){if(e.left!==e.right)if(void 0!==e.left)if(void 0!==e.right){if("function"==typeof e.left||"function"==typeof e.right)throw new Error("functions are not supported");e.leftType=null===e.left?"null":typeof e.left,e.rightType=null===e.right?"null":typeof e.right,e.leftType===e.rightType&&"boolean"!==e.leftType&&"number"!==e.leftType?("object"===e.leftType&&(e.leftIsArray=Array.isArray(e.left)),"object"===e.rightType&&(e.rightIsArray=Array.isArray(e.right)),e.leftIsArray===e.rightIsArray?e.left instanceof RegExp&&(e.right instanceof RegExp?e.setResult([e.left.toString(),e.right.toString()]).exit():e.setResult([e.left,e.right]).exit()):e.setResult([e.left,e.right]).exit()):e.setResult([e.left,e.right]).exit()}else e.setResult([e.left,0,0]).exit();else{if("function"==typeof e.right)throw new Error("functions are not supported");e.setResult([e.right]).exit()}else e.setResult(void 0).exit()};d.filterName="trivial";const h=function(e){if(void 0===e.delta)return void e.setResult(e.left).exit();if(e.nested=!Array.isArray(e.delta),e.nested)return;const t=e.delta;if(1!==t.length)if(2!==t.length)3===t.length&&0===t[2]&&e.setResult(void 0).exit();else{if(e.left instanceof RegExp){const n=/^\/(.*)\/([gimyu]+)$/.exec(t[1]);if(n)return void e.setResult(new RegExp(n[1],n[2])).exit()}e.setResult(t[1]).exit()}else e.setResult(t[0]).exit()};h.filterName="trivial";const f=function(e){if(void 0===e.delta)return void e.setResult(e.delta).exit();if(e.nested=!Array.isArray(e.delta),e.nested)return;const t=e.delta;1!==t.length?2!==t.length?3===t.length&&0===t[2]&&e.setResult([t[0]]).exit():e.setResult([t[1],t[0]]).exit():e.setResult([t[0],0,0]).exit()};f.filterName="trivial";const u=e=>{if(!e||!e.children)return;const t=e.children.length;let n,i=e.result;for(let o=0;o<t;o++)n=e.children[o],void 0!==n.result&&(i=i||{},i[n.childName]=n.result);i&&e.leftIsArray&&(i._t="a"),e.setResult(i).exit()};u.filterName="collectChildren";const m=e=>{if(e.leftIsArray||"object"!==e.leftType)return;const t=e.left,n=e.right;let i,o;const s=e.options.propertyFilter;for(i in t)Object.prototype.hasOwnProperty.call(t,i)&&(s&&!s(i,e)||(o=new a(t[i],n[i]),e.push(o,i)));for(i in n)Object.prototype.hasOwnProperty.call(n,i)&&(s&&!s(i,e)||void 0===t[i]&&(o=new a(void 0,n[i]),e.push(o,i)));e.children&&0!==e.children.length?e.exit():e.setResult(void 0).exit()};m.filterName="objects";const g=function(e){if(!e.nested)return;const t=e.delta;if(t._t)return;const n=t;let i,o;for(i in n)o=new l(e.left[i],n[i]),e.push(o,i);e.exit()};g.filterName="objects";const p=function(e){if(!e||!e.children)return;if(e.delta._t)return;const t=e.left,n=e.children.length;let i;for(let o=0;o<n;o++){i=e.children[o];const n=i.childName;Object.prototype.hasOwnProperty.call(e.left,n)&&void 0===i.result?delete t[n]:t[n]!==i.result&&(t[n]=i.result)}e.setResult(t).exit()};p.filterName="collectChildren";const y=function(e){if(!e.nested)return;if(e.delta._t)return;const t=e.delta;let n,i;for(n in t)i=new c(t[n]),e.push(i,n);e.exit()};y.filterName="objects";const v=e=>{if(!e||!e.children)return;if(e.delta._t)return;const t=e.children.length;let n;const i={};for(let o=0;o<t;o++){n=e.children[o];const t=n.childName;i[t]!==n.result&&(i[t]=n.result)}e.setResult(i).exit()};v.filterName="collectChildren";const w=function(e,t,n,i){return e[n]===t[i]},x=function(e,t,n,i){const o=i||{},s=function(e,t,n,i){const o=e.length,s=t.length;let r,a;const l=new Array(o+1);for(r=0;r<o+1;r++)for(l[r]=new Array(s+1),a=0;a<s+1;a++)l[r][a]=0;for(l.match=n,r=1;r<o+1;r++)for(a=1;a<s+1;a++)n(e,t,r-1,a-1,i)?l[r][a]=l[r-1][a-1]+1:l[r][a]=Math.max(l[r-1][a],l[r][a-1]);return l}(e,t,n||w,o);return function(e,t,n,i){let o=t.length,s=n.length;const r={sequence:[],indices1:[],indices2:[]};for(;0!==o&&0!==s;)e.match(t,n,o-1,s-1,i)?(r.sequence.unshift(t[o-1]),r.indices1.unshift(o-1),r.indices2.unshift(s-1),--o,--s):e[o][s-1]>e[o-1][s]?--s:--o;return r}(s,e,t,o)};function b(e,t,n,i,o){const s=e[n],r=t[i];if(s===r)return!0;if("object"!=typeof s||"object"!=typeof r)return!1;const a=o.objectHash;if(!a)return o.matchByPosition&&n===i;o.hashCache1=o.hashCache1||[];let l=o.hashCache1[n];if(void 0===l&&(o.hashCache1[n]=l=a(s,n)),void 0===l)return!1;o.hashCache2=o.hashCache2||[];let c=o.hashCache2[i];return void 0===c&&(o.hashCache2[i]=c=a(r,i)),void 0!==c&&l===c}const k=function(e){if(!e.leftIsArray)return;const t={objectHash:e.options&&e.options.objectHash,matchByPosition:e.options&&e.options.matchByPosition};let n,i,o,s=0,r=0;const l=e.left,c=e.right,d=l.length,h=c.length;let f,u;for(d>0&&h>0&&!t.objectHash&&"boolean"!=typeof t.matchByPosition&&(t.matchByPosition=!function(e,t,n,i){for(let o=0;o<n;o++){const n=e[o];for(let e=0;e<i;e++){const i=t[e];if(o!==e&&n===i)return!0}}}(l,c,d,h));s<d&&s<h&&b(l,c,s,s,t);)n=s,f=new a(l[n],c[n]),e.push(f,n),s++;for(;r+s<d&&r+s<h&&b(l,c,d-1-r,h-1-r,t);)i=d-1-r,o=h-1-r,f=new a(l[i],c[o]),e.push(f,o),r++;if(s+r===d){if(d===h)return void e.setResult(void 0).exit();for(u=u||{_t:"a"},n=s;n<h-r;n++)u[n]=[c[n]];return void e.setResult(u).exit()}if(s+r===h){for(u=u||{_t:"a"},n=s;n<d-r;n++)u[`_${n}`]=[l[n],0,0];return void e.setResult(u).exit()}delete t.hashCache1,delete t.hashCache2;const m=l.slice(s,d-r),g=c.slice(s,h-r),p=x(m,g,b,t),y=[];for(u=u||{_t:"a"},n=s;n<d-r;n++)p.indices1.indexOf(n-s)<0&&(u[`_${n}`]=[l[n],0,0],y.push(n));let v=!0;e.options&&e.options.arrays&&!1===e.options.arrays.detectMove&&(v=!1);let w=!1;e.options&&e.options.arrays&&e.options.arrays.includeValueOnMove&&(w=!0);const k=y.length;for(n=s;n<h-r;n++){const r=p.indices2.indexOf(n-s);if(r<0){let r=!1;if(v&&k>0)for(let d=0;d<k;d++)if(i=y[d],b(m,g,i-s,n-s,t)){u[`_${i}`].splice(1,2,n,3),w||(u[`_${i}`][0]=""),o=n,f=new a(l[i],c[o]),e.push(f,o),y.splice(d,1),r=!0;break}r||(u[n]=[c[n]])}else i=p.indices1[r]+s,o=p.indices2[r]+s,f=new a(l[i],c[o]),e.push(f,o)}e.setResult(u).exit()};k.filterName="arrays";const S={numerically:(e,t)=>e-t,numericallyBy:e=>(t,n)=>t[e]-n[e]},E=function(e){if(!e.nested)return;const t=e.delta;if("a"!==t._t)return;let n,i;const o=t,s=e.left;let r=[],a=[];const c=[];for(n in o)if("_t"!==n)if("_"===n[0]){const e=n;if(0!==o[e][2]&&3!==o[e][2])throw new Error(`only removal or move can be applied at original array indices, invalid diff type: ${o[e][2]}`);r.push(parseInt(n.slice(1),10))}else{const e=n;1===o[e].length?a.push({index:parseInt(e,10),value:o[e][0]}):c.push({index:parseInt(e,10),delta:o[e]})}for(r=r.sort(S.numerically),n=r.length-1;n>=0;n--){i=r[n];const e=o[`_${i}`],t=s.splice(i,1)[0];3===e[2]&&a.push({index:e[1],value:t})}a=a.sort(S.numericallyBy("index"));const d=a.length;for(n=0;n<d;n++){const e=a[n];s.splice(e.index,0,e.value)}const h=c.length;let f;if(h>0)for(n=0;n<h;n++){const t=c[n];f=new l(s[t.index],t.delta),e.push(f,t.index)}e.children?e.exit():e.setResult(s).exit()};E.filterName="arrays";const _=function(e){if(!e||!e.children)return;if("a"!==e.delta._t)return;const t=e.left,n=e.children.length;let i;for(let o=0;o<n;o++)i=e.children[o],t[i.childName]=i.result;e.setResult(t).exit()};_.filterName="arraysCollectChildren";const M=function(e){if(!e.nested){const t=e.delta;if(3===t[2]){const n=t;e.newName=`_${n[1]}`,e.setResult([n[0],parseInt(e.childName.substring(1),10),3]).exit()}return}const t=e.delta;if("a"!==t._t)return;const n=t;let i,o;for(i in n)"_t"!==i&&(o=new c(n[i]),e.push(o,i));e.exit()};M.filterName="arrays";const I=(e,t,n)=>{if("string"==typeof t&&"_"===t[0])return parseInt(t.substring(1),10);if(Array.isArray(n)&&0===n[2])return`_${t}`;let i=+t;for(const o in e){const n=e[o];if(Array.isArray(n))if(3===n[2]){const e=parseInt(o.substring(1),10),s=n[1];if(s===+t)return e;e<=i&&s>i?i++:e>=i&&s<i&&i--}else 0===n[2]?parseInt(o.substring(1),10)<=i&&i++:1===n.length&&parseInt(o,10)<=i&&i--}return i},T=e=>{if(!e||!e.children)return;const t=e.delta;if("a"!==t._t)return;const n=t,i=e.children.length;let o;const s={_t:"a"};for(let r=0;r<i;r++){o=e.children[r];let t=o.newName;void 0===t&&(t=I(n,o.childName,o.result)),s[t]!==o.result&&(s[t]=o.result)}e.setResult(s).exit()};T.filterName="arraysCollectChildren";const A=function(e){e.left instanceof Date?(e.right instanceof Date?e.left.getTime()!==e.right.getTime()?e.setResult([e.left,e.right]):e.setResult(void 0):e.setResult([e.left,e.right]),e.exit()):e.right instanceof Date&&e.setResult([e.left,e.right]).exit()};A.filterName="dates";let D=null;function R(e,t){var n;if(!D){let i;if(!(null===(n=null==e?void 0:e.textDiff)||void 0===n?void 0:n.diffMatchPatch)){if(!t)return null;const e=new Error("The diff-match-patch library was not provided. Pass the library in through the options or use the `jsondiffpatch/with-text-diffs` entry-point.");throw e.diff_match_patch_not_found=!0,e}i=new e.textDiff.diffMatchPatch,D={diff:function(e,t){return i.patch_toText(i.patch_make(e,t))},patch:function(e,t){const n=i.patch_apply(i.patch_fromText(t),e);for(let i=0;i<n[1].length;i++)n[1][i]||(new Error("text patch failed").textPatchFailed=!0);return n[0]}}}return D}const L=function(e){if("string"!==e.leftType)return;const t=e.left,n=e.right,i=e.options&&e.options.textDiff&&e.options.textDiff.minLength||60;if(t.length<i||n.length<i)return void e.setResult([t,n]).exit();const o=R(e.options);if(!o)return void e.setResult([t,n]).exit();const s=o.diff;e.setResult([s(t,n),0,2]).exit()};L.filterName="texts";const N=function(e){if(e.nested)return;const t=e.delta;if(2!==t[2])return;const n=t,i=R(e.options,!0).patch;e.setResult(i(e.left,n[0])).exit()};N.filterName="texts";const O=function(e){let t,n,i,o,s=null;const r=/^@@ +-(\d+),(\d+) +\+(\d+),(\d+) +@@$/;let a;const l=e.split("\n");for(t=0,n=l.length;t<n;t++){i=l[t];const e=i.slice(0,1);"@"===e?(s=r.exec(i),a=t,l[a]="@@ -"+s[3]+","+s[4]+" +"+s[1]+","+s[2]+" @@"):"+"===e?(l[t]="-"+l[t].slice(1),"+"===l[t-1].slice(0,1)&&(o=l[t],l[t]=l[t-1],l[t-1]=o)):"-"===e&&(l[t]="+"+l[t].slice(1))}return l.join("\n")},P=function(e){if(e.nested)return;const t=e.delta;if(2!==t[2])return;const n=t;e.setResult([O(n[0]),0,2]).exit()};P.filterName="texts";class C{constructor(e){this.processor=new i(e),this.processor.pipe(new o("diff").append(u,d,A,L,m,k).shouldHaveResult()),this.processor.pipe(new o("patch").append(p,_,h,N,g,E).shouldHaveResult()),this.processor.pipe(new o("reverse").append(v,T,f,P,y,M).shouldHaveResult())}options(e){return this.processor.options(e)}diff(e,t){return this.processor.process(new a(e,t))}patch(e,t){return this.processor.process(new l(e,t))}reverse(e){return this.processor.process(new c(e))}unpatch(e,t){return this.patch(e,this.reverse(t))}clone(e){return r(e)}}function q(e){return new C(e)}let F;function $(e,t){return F||(F=new C),F.patch(e,t)}function B(e){let t=JSON.parse(e);if(Array.isArray(t)){const e=t,n=JSON.parse(e[0]),i=[];let o=n;const s=q({objectHash:(e,t)=>"id"in e?e.id:"$$index:"+t});for(let t=1;t<e.length;t++){const n=JSON.parse(e[t]),r=s.diff(o,n);i.push(r),o=n}t={format:"snakeshift-playthrough",formatVersion:2,baseState:n,deltas:i}}if(!("format"in t))throw new Error('Invalid format. Missing "format" property.');if(!("formatVersion"in t))throw new Error('Invalid format. Missing "formatVersion" property.');if("snakeshift-playthrough"!==t.format)throw new Error(`Invalid format. Expected "snakeshift-playthrough", got ${JSON.stringify(t.format)}`);if("number"!=typeof t.formatVersion)throw new Error(`Invalid format. Expected "number", got ${JSON.stringify(t.formatVersion)} for "formatVersion" property.`);if(t.formatVersion>2)throw new Error("Format version is too new");if(2!==t.formatVersion)throw new Error("Invalid format version");if(!("baseState"in t))throw new Error('Invalid format. Missing "baseState" property.');if(!("deltas"in t))throw new Error('Invalid format. Missing "deltas" property.');let n=t.baseState;const i=[JSON.stringify(n)];for(const o of t.deltas)if(o){const e=$(n,o);i.push(JSON.stringify(e)),n=e}else i.push(JSON.stringify(n));return i}function G(e,t){return e._type===t}const z="snakeshift:muteSoundEffects",j="snakeshift:volume",W="snakeshift:hapticsEnabled",K="snakeshift:hapticsValidDuration",V="snakeshift:hapticsInvalidDuration",H="snakeshift:gamepadRepeatRate",U="snakeshift:gamepadRepeatDelay",J="snakeshift:pointerMoveThreshold",Y=e=>`snakeshift:bestSolution:${e}`,Z=e=>`snakeshift:bestMoveCount:${e}`,X="snakeshift:localStorageFormatVersion",Q=[];window.AudioContext??=window.webkitAudioContext;const ee=new AudioContext,te=ee.createGain();te.connect(ee.destination);const ne=document.getElementById("load-progress"),ie=document.getElementById("mute-button"),oe=document.getElementById("mute-button-text");let se="true"===n.getItem(z),re=parseFloat(n.getItem(j));(!isFinite(re)||re<0||re>1)&&(re=.5),te.gain.value=re;const ae={},le={undo:"audio/sound-effects/undo.wav",redo:"audio/sound-effects/redo.wav",gong:"audio/sound-effects/gong-2-232435.mp3",gongBrilliant:"audio/sound-effects/486629__jenszygar__gong-brilliant-paiste-32.mp3",eat:"audio/sound-effects/glockenspiel_a-102771.mp3",move:"audio/sound-effects/tiny-drip.wav",switchSnakes:"audio/sound-effects/snake-hissing-6092.mp3",pushCrate:"audio/sound-effects/509532__mindlesstrails__bookcasedrag__sample.mp3",resize:"audio/sound-effects/736438__riley_garinger__woodfric-scraping-dragging-wooden-4x4-post-on-concrete-02__sample.mp3"},ce=Object.keys(le).length;let de=0;const he=[];function fe(){se||ee.resume()}function ue({savePreference:e=!0}={}){se=!se,me(),e&&n.setItem(z,String(se)),se?ee.suspend():ee.resume()}const me=()=>{ie.ariaPressed=se?"true":"false",oe.textContent=se?"Unmute":"Mute",ie.querySelector(".when-muted").hidden=!se,ie.querySelector(".when-unmuted").hidden=se},ge=async e=>{const t=await fetch(e);if(t.ok)return await ee.decodeAudioData(await t.arrayBuffer());throw new Error(`got HTTP ${t.status} fetching '${e}'`)},pe=(e,t)=>{alert(`${e}\n\n${t}`)};function ye(e,{playbackRate:t=1,volume:n=1,cutOffEndFraction:i=0}={}){try{if(se)return;Q.push(e);const o=ae[e];if(!o)throw new Error(`No AudioBuffer loaded for sound '${e}'`);if("running"!==ee.state)return void console.warn("Audio context not running, can't play sound");const s=ee.createGain(),r=ee.createBufferSource();r.buffer=o,r.connect(s),s.connect(te),s.gain.value=n,r.playbackRate.value=t,i&&s.gain.linearRampToValueAtTime(0,ee.currentTime+o.duration*(1-i)),r.start(0)}catch(o){console.error(`Failed to play sound '${e}':`,o)}}const ve=[..."CDEGACFAGCEGFECAGCDFECGEDBGDCGEGCDEGAFCAEDCAFECAGACEGECGAGDBEGCEGCEGCGGECGC".replace(/^([A-Z]:|%).*$/gim,"").matchAll(/([A-G])([,'])*/gi)].map((e=>{const t=e[1],n="'"===e[2]?1:","===e[2]?-1:0;return 12*((t===t.toUpperCase()?1:0)+n+4)+"CDEFGAB".indexOf(t.toUpperCase())})).map((e=>440*Math.pow(2,(e-69)/12)));ie.addEventListener("click",(()=>{ue()})),me();class we{fromJSON(e){Object.assign(this,e)}solid=!0}var xe=(e=>(e.KeyboardAbsoluteDirection="KeyboardAbsoluteDirection",e.KeyboardFacingRelative="KeyboardFacingRelative",e.Gamepad="Gamepad",e.Pointer="Pointer",e))(xe||{}),be=(e=>(e[e.None=0]="None",e[e.White=1]="White",e[e.Black=2]="Black",e[e.Both=3]="Both",e))(be||{});const ke=[{x:1,y:0},{x:0,y:1},{x:-1,y:0},{x:0,y:-1}],Se=document.createElement("img"),Ee=new Promise((e=>Se.onload=e));Se.src="graphics/shrubbery-24.svg",Se.width=128,Se.height=128;let _e=null;class Me extends we{constructor(e=0,t=0,n=1,i=1,o=be.White){super(),this.x=e,this.y=t,this.width=n,this.height=i,this.layer=o}at(e,t){return e>=this.x&&e<this.x+this.width&&t>=this.y&&t<this.y+this.height?{entity:this,layer:this.layer}:null}draw(e){const t=1/e.getTransform().a;if(this.layer===be.Both){const n=4;for(let i=0;i<n;i++)for(let o=0;o<n;o++)e.fillStyle=(i+o)%2==0?"#fff":"#000",e.fillRect(this.x+i*this.width/n,this.y+o*this.height/n,this.width/n+t,this.height/n+t)}else if(this.layer===be.None){if(!_e){_e=e.createPattern(Se,"repeat");const t=document.createElement("canvas");t.width=Se.width,t.height=Se.height,t.getContext("2d").drawImage(Se,0,0,Se.width,Se.height),_e=e.createPattern(t,"repeat")}_e&&(_e.setTransform((new DOMMatrix).scale(1/Se.width,1/Se.height)),e.fillStyle=_e,e.fillRect(this.x,this.y,this.width+t,this.height+t))}else e.fillStyle=this.layer===be.White?"#fff":"#000",e.fillRect(this.x,this.y,this.width+t,this.height+t)}}class Ie extends Me{static VISUAL_SIZE=.5;solid=!1;draw(e){e.save(),e.lineWidth=.1,e.strokeStyle=this.layer===be.White?"#000":"#fff",e.fillStyle=this.layer===be.White?"#fff":"#000",e.translate(this.x,this.y),e.scale(this.width,this.height),e.translate(.5,.5),e.beginPath(),e.arc(0,0,Ie.VISUAL_SIZE/2,0,2*Math.PI),e.stroke(),e.fill(),e.restore()}}class Te extends Ie{static VISUAL_SIZE=.8;solid=!1;_time=0;toJSON(){const e={...this};return delete e._time,delete e.solid,e}step(e){this._time=e}draw(e){e.save(),e.lineWidth=.1,e.strokeStyle=this.layer===be.White?"#000":"#fff",e.fillStyle=this.layer===be.White?"#fff":"#000",e.translate(this.x,this.y),e.scale(this.width,this.height),e.translate(.5,.5),e.rotate(Math.sin(this._time/1e3+this.x/10+this.y/10)*Math.PI/12),e.beginPath(),e.moveTo(0,-Te.VISUAL_SIZE/2);for(let t=0;t<4;t++)e.rotate(Math.PI/2),e.quadraticCurveTo(0,0,0,-Te.VISUAL_SIZE/2);e.stroke(),e.fill(),e.restore()}}class Ae extends Me{}class De extends Me{_drawLife(e,t,n){e.save(),e.translate(this.x+this.width/2,this.y+this.height/2),e.scale(this.width,this.height),e.fillStyle=this.layer===be.White?"#fff":"#000",e.strokeStyle=this.layer===be.White?"#000":"#fff",e.lineWidth=.1,e.lineJoin="round",e.lineCap="round",e.beginPath();const i=performance.now()/1e3+.3*this.x+.3*this.y;for(let o=0;o<8;o++){const t=o%2==0,n=Math.sin(i)*(t?.1:.02)+.6,s=.05*Math.cos(i)+.2,r=.1*Math.sin(i+Math.PI*o/8)+.5;e.rotate(2*Math.PI/8),e.moveTo(0,0),e.bezierCurveTo(n,0,n+r,s,n,s),e.bezierCurveTo(n,s,n,s+r,0,s)}e.closePath(),t&&e.fill(),n&&e.stroke(),e.restore()}draw(e){this._drawLife(e,!1,!0)}draw2(e){this._drawLife(e,!0,!1)}}class Re extends Me{draw(e){const t=1/e.getTransform().a;e.save(),e.lineWidth=.2,e.strokeStyle=this.layer===be.White?"#fff":"#000",e.fillStyle=this.layer===be.White?"#fff":"#000",e.beginPath();const n=.1;e.rect(this.x+n,this.y+n,this.width-.2+t,this.height-.2+t),e.fill(),e.stroke(),e.lineWidth=.05,e.strokeStyle=this.layer===be.White?"#000":"#fff",e.stroke(),e.clip(),e.beginPath(),e.moveTo(this.x,this.y),e.lineTo(this.x+this.width,this.y+this.height),e.lineWidth=.2,e.strokeStyle=this.layer===be.White?"#000":"#fff",e.stroke(),e.lineWidth=.1,e.strokeStyle=this.layer===be.White?"#fff":"#000",e.stroke(),e.beginPath(),e.moveTo(this.x+this.width,this.y),e.lineTo(this.x,this.y+this.height),e.lineWidth=.2,e.strokeStyle=this.layer===be.White?"#000":"#fff",e.stroke(),e.lineWidth=.1,e.strokeStyle=this.layer===be.White?"#fff":"#000",e.stroke(),e.restore()}}const Le=document.createElement("img"),Ne=new Promise((e=>Le.onload=e));Le.src="graphics/yin-yang.svg",Le.width=128,Le.height=128;let Oe,Pe,Ce=null;class qe extends Ie{static VISUAL_SIZE=.8;solid=!1;_time=0;toJSON(){const e={...this};return delete e._time,delete e.solid,e}step(e){this._time=e}draw(e){if(e.save(),e.translate(this.x,this.y),e.scale(this.width,this.height),e.translate(.5,.5),e.rotate(-(this._time/1e3+this.x/10+this.y/10)*Math.PI/12),!Ce){Ce=e.createPattern(Le,"repeat");const t=document.createElement("canvas");t.width=Le.width,t.height=Le.height,t.getContext("2d").drawImage(Le,0,0,Le.width,Le.height),Ce=e.createPattern(t,"repeat")}Ce&&(Ce.setTransform((new DOMMatrix).translate(-.5,-.5).scale(1/Le.width,1/Le.height)),e.fillStyle=Ce,e.fillRect(-this.width/2,-this.height/2,this.width,this.height)),e.restore()}}function Fe(e,t={}){Oe&&(Oe.remove(),Oe=void 0),e&&(gn||"edit"===xn)&&(Oe=document.createElement("div"),Oe.classList.add("hover-effect"),document.body.appendChild(Oe),Oe?.classList.toggle("active-effect",t.pressed??!1),Oe?.classList.toggle("valid",t.valid??!0),Oe?.classList.toggle("selection",t.isSelection??!1),$e(Oe,Qe(e)))}function $e(e,t){e.style.left=`${t.x}px`,e.style.top=`${t.y}px`,e.style.width=`${t.width}px`,e.style.height=`${t.height}px`}function Be(e,t={}){const n=!(!e||!gn)&&function(e,t){const n=Math.round(t.x-e.segments[0].x),i=Math.round(t.y-e.segments[0].y);return ii(e,n,i)}(gn,e).valid;Fe(e,{valid:n,...t})}const Ge=document.createElement("canvas");Ge.style.touchAction="none";const ze=Ge.getContext("2d");document.body.appendChild(Ge);const je=document.getElementById("entities-bar"),We=document.getElementById("replay-bar"),Ke=document.getElementById("game-options-bar");let Ve;function He(){const e=window.innerWidth,t=Ke.getBoundingClientRect();je.style.paddingTop=`${t.bottom+5}px`,We.style.paddingTop=`${t.bottom+5}px`;const n=je.getBoundingClientRect(),i=We.getBoundingClientRect(),o=Math.max(n.bottom,i.bottom,t.bottom)+5,s=window.innerHeight-o-5;Ge.style.transform=`translateY(${o}px)`,Ge.style.width=`${e}px`,Ge.style.height=`${s}px`;const r=Math.floor(e*devicePixelRatio),a=Math.floor(s*devicePixelRatio),l=Ge.width!==r||Ge.height!==a;l&&(Ge.width=r,Ge.height=a),ze.fillStyle="#000",ze.fillRect(0,0,Ge.width,Ge.height),ze.save(),ze.translate(Ge.width/2,Ge.height/2);const c=mn.width+.4,d=mn.height+.4,h=mn.width/2,f=mn.height/2,u=Math.min(Ge.width/c,Ge.height/d);ze.scale(u,u),ze.translate(-h,-f),Ve=ze.getTransform(),l&&function(){for(const e of $n)e()}(),Ue(ze,fn),function(e){e.save(),e.globalAlpha=.5,e.fillStyle="#f00",e.font="1px sans-serif",e.textAlign="center",e.textBaseline="middle";for(const{tile:t,type:n}of Je){const i="overlap"===n?"ðŸ——":"ðŸ›‡",o=.2*Math.sin(performance.now()/200)+1;e.save(),e.translate(t.x+t.width/2,t.y+t.height/2),e.scale(o,o),e.fillText(i,0,0),e.restore()}e.restore()}(ze),function(e){Pe||(Pe=document.createElement("div"),Pe.classList.add("level-border"),document.body.appendChild(Pe)),$e(Pe,Qe({x:0,y:0,width:e.width,height:e.height}))}(mn),ze.restore();for(const m of document.querySelectorAll(".level-specific-overlay, #level-stuck-hint"))$e(m,Qe({x:0,y:0,width:mn.width,height:mn.height}))}function Ue(e,t){for(const n of t)n.draw?.(e);for(const n of t)n.draw2?.(e);for(const n of t)n.draw3?.(e)}const Je=[];function Ye(e,t){Je.push({tile:e,type:t})}function Ze(e){const t=Ge.getBoundingClientRect(),n=new DOMPoint(e.x,e.y).matrixTransform(Ve);return{x:n.x/devicePixelRatio+t.left,y:n.y/devicePixelRatio+t.top}}function Xe(e){const t=function(e){const t=Ge.getBoundingClientRect(),n=e.clientX-t.left,i=e.clientY-t.top;if(!Ve)return{x:0,y:0};const o=new DOMPoint(n*devicePixelRatio,i*devicePixelRatio).matrixTransform(Ve.inverse());return{x:o.x,y:o.y}}(e);return{x:Math.floor(t.x),y:Math.floor(t.y),width:1,height:1}}function Qe(e){const t=Ze(e),n=Ze({x:e.x+e.width,y:e.y+e.height});return{x:t.x,y:t.y,width:n.x-t.x,height:n.y-t.y}}let et,tt,nt,it="Brush",ot=Ae,st=be.White,rt=[],at=0,lt=!1,ct=[],dt=()=>{};function ht(){if(nt)return{x:Math.min(nt.startTile.x,nt.endTile.x),y:Math.min(nt.startTile.y,nt.endTile.y),width:Math.abs(nt.startTile.x-nt.endTile.x)+1,height:Math.abs(nt.startTile.y-nt.endTile.y)+1}}function ft(){const e=document.getElementById("entities-bar"),t=e.querySelectorAll(".entity-button"),n=e.querySelectorAll(".tool-button");function i(e){nt=void 0,Fe(void 0);for(const t of n)t.classList.remove("selected");e.classList.add("selected")}const o=document.querySelector(".tool-button[data-tool='Eraser'"),s=document.querySelector(".tool-button[data-tool='Move'"),r=document.querySelector(".tool-button[data-tool='Select'"),a=document.querySelector("#clear-button"),l=document.querySelector("#invert-button"),c=document.querySelector("#level-info-button"),d=document.querySelector("#level-info-editor"),h=document.querySelector("#level-info-editor-ok-button"),f=document.querySelector("#level-info-editor-cancel-button"),u=document.querySelector("#save-button"),m=document.querySelector("#open-button");u.addEventListener("click",Vn),m.addEventListener("click",Zn),o.addEventListener("click",(()=>{it="Eraser",i(o)})),s.addEventListener("click",(()=>{it="Move",i(s)})),r.addEventListener("click",(()=>{it="Select",i(r)})),a.addEventListener("click",(()=>{ct.length||nt?mt():Cn(!0,!1)})),l.addEventListener("click",gt),c.addEventListener("click",(()=>{d.showModal();const e=d.querySelector("#level-width"),t=d.querySelector("#level-height");e.value=mn.width.toString(),t.value=mn.height.toString(),e.select()})),d.addEventListener("close",(()=>{console.log(d.returnValue)})),d.addEventListener("keydown",(e=>{"Escape"===e.key&&d.close(),e.stopPropagation()})),h.addEventListener("click",(e=>{e.preventDefault(),In();const t=parseInt(d.querySelector("#level-width").value),n=parseInt(d.querySelector("#level-height").value);isNaN(t)||isNaN(n)?alert("Invalid input. Please enter a number."):(t===mn.width&&n===mn.height||(mn.width=t,mn.height=n,ye("resize")),zn(),d.close())})),f.addEventListener("click",(e=>{e.preventDefault(),d.close()})),dt=()=>{it="Select",i(r)};for(const p of t)g(p);function g(e){const t=e.getAttribute("data-entity"),n=e.getAttribute("data-color"),o="White"===n?be.White:"Black"===n?be.Black:"Both"===n?be.Both:be.None;e.addEventListener("click",(()=>{ot=Tt(t).constructor,st=o,it="Brush",i(e)})),e.classList.toggle("selected",t===ot.name&&o===st&&"Brush"===it);const s=document.createElement("canvas"),r=s.getContext("2d");function a(){s.style.width="48px",s.style.height="48px",s.width=48*devicePixelRatio,s.height=48*devicePixelRatio;const e=function(){const e=Tt(t);if(e instanceof xt)for(const t of e.segments)t.layer=o;else e instanceof Me&&(e.layer=o);return e}();r.scale(devicePixelRatio,devicePixelRatio),r.translate(8,8),r.scale(32,32),Ue(r,[e])}e.prepend(s),a(),addEventListener("resize",a)}"Move"===it?i(s):"Eraser"===it?i(o):"Select"===it&&i(r)}function ut(e){const{on:t,removeEventListeners:n}=Ot();function i(){const e=o&&bt(s,o);let t=!1;s&&("Move"===it?t=Dt(s.x,s.y).length>0:St(s)&&(t=!0)),"Select"===it?Fe(ht(),{isSelection:!0,valid:!0}):Fe(s,{pressed:e,valid:t}),function(){Je.length=0;const e=new Map;for(const t of fn){const n=t instanceof Me?`${t.x},${t.y}`:"?,?",i=e.get(n)??[];if(i.push(t),e.set(n,i),t instanceof Me)St(t)||Ye(t,"out-of-bounds");else if(t instanceof xt)for(const e of t.segments){St(e)||Ye(e,"out-of-bounds");for(const n of t.segments)e!==n&&bt(e,n)&&Ye(e,"overlap");Rt(Dt(e.x,e.y).filter((e=>e.entity!==t&&fn.indexOf(e.entity)<fn.indexOf(t))))===e.layer&&Ye(e,"collision")}}for(const t of e.values()){const e=t.filter((e=>e instanceof Ie));e.length>1&&Ye(e[1],"overlap")}}()}let o,s;function r(e){o=void 0,tt=void 0,rt=[],at=0,et=void 0,lt=!1,nt?.defining&&(nt.defining=!1),s=Xe(e),St(s)||(s=void 0),i()}function a(e,t,n){if(t&&n&&o)if(2===e.buttons||"Eraser"===it&&1===e.buttons)for(const i of Mt(t,n))c({x:i.x,y:i.y,width:1,height:1});else if(1===e.buttons&&"Brush"===it){ot===xt&&tt instanceof xt&&(t=tt.segments[0]);const e=ot===xt?It:Mt;for(const i of e(t,n)){let e={x:i.x,y:i.y,width:1,height:1};if(ot===xt&&(e=_t(e)),!l(e))break}}}function l(e){const t=Dt(e.x,e.y);if(St(e)&&Rt(t)!==st&&!t.some((e=>e.entity instanceof Ie))||tt instanceof xt&&!bt(e,tt.segments[0])){lt||(In(),lt=!0);const n=tt??new ot;if(tt||n instanceof xt&&(n.segments.length=0,tt=n),n instanceof xt){if(t.filter((e=>e.entity instanceof xt)).map((e=>e.entity)).includes(n))return n.segments.length>1&&bt(n.segments[1],e)&&n.segments.shift(),!1;n.segments.unshift({layer:st,x:e.x,y:e.y,width:1,height:1})}else n instanceof Me&&(n.layer=st,n.x=e.x,n.y=e.y);fn.includes(n)||fn.push(n),At(),zn()}return!0}function c(e){const t=Dt(e.x,e.y);for(const n of t)fn.indexOf(n.entity)>=0&&(lt||(In(),lt=!0),n.entity instanceof xt?wt(n.entity,n.segmentIndex):vt(n.entity))}function d(e,t){if(t=_t(t),e instanceof Me)e.x=t.x,e.y=t.y;else if(e instanceof xt){const n=e.segments[at];if(n.x!==t.x||n.y!==t.y){const i={x:n.x,y:n.y};for(const o of[...It(i,t)].slice(1)){for(let t=e.segments.length-1;t>at;t--)h(e.segments[t-1],e.segments[t]);for(let t=0;t<at;t++)h(e.segments[t+1],e.segments[t]);n.x=o.x,n.y=o.y,xt.DEBUG_SNAKE_DRAGGING&&He()}}}}function h(e,t){t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height,xt.DEBUG_SNAKE_DRAGGING&&He()}function f(){const e=ht();e&&(ct=fn.filter((t=>t instanceof Me?Et(t,e):t instanceof xt&&t.segments.some((t=>Et(t,e))))),zn())}return Bn(i),Gn(i),t(e,"pointerdown",(e=>{o=Xe(e);const t=ht(),n=t&&o&&Et(o,t);if(St(o)||"Select"===it||(o=void 0),s=o,!o||rt.length||0!==e.button||"Move"!==it&&!n)o&&0===e.button&&"Select"===it?(nt={startTile:{...o},endTile:{...o},defining:!0},f(),i()):s&&a(e,s,s);else{if(n)rt=[...ct],at=0,et=o;else{const e=Dt(o.x,o.y)[0];rt=[e?.entity].filter(Boolean),at=e?.segmentIndex??0,et=void 0}if(rt.length){In();for(const e of rt)fn.splice(fn.indexOf(e),1);fn.push(...rt),At()}i()}})),t(window,"pointerup",r),t(window,"pointercancel",r),t(window,"pointermove",(e=>{const t=s;if(s=Xe(e),o||St(s)||(s=void 0),s)if(rt.length||et)if(nt&&et)yt(s.x-et.x,s.y-et.y),et=s;else for(const n of rt)d(n,s);else nt?.defining&&o?(nt.endTile={...s},f()):a(e,t,s);bt(t,s)||i()})),n}function mt(){if(ct.length){In();for(const e of ct){const t=fn.indexOf(e);t>=0&&fn.splice(t,1)}}ct.length=0,nt=void 0,Fe(void 0),zn()}function gt(){In();const e=ct.length||nt?ct:fn,t=ht()??{x:0,y:0,width:mn.width,height:mn.height};for(const n of e)if(n instanceof Me)n.layer=Nt(n.layer);else if(n instanceof xt)for(const e of n.segments)e.layer=Nt(e.layer);for(let n=t.x;n<t.x+t.width;n++)for(let e=t.y;e<t.y+t.height;e++)if(!Dt(n,e).some((e=>e.entity instanceof Ae))){const t=new Ae;t.layer=be.White,t.x=n,t.y=e,fn.unshift(t),nt&&ct.push(t)}zn()}async function pt(){const e=ht();if(!e)return;const t=On(),n=ct.map((e=>fn.indexOf(e))),i=JSON.parse(JSON.stringify(nt));let o;try{mn.width=e.width,mn.height=e.height,yt(-e.x,-e.y),fn.splice(0,fn.length,...ct),o=On()}finally{Pn(t,null,!0),ct=n.map((e=>fn[e])),nt=i,zn()}try{await navigator.clipboard.writeText(o)}catch(s){alert(`Error copying: ${String(s)}`)}}function yt(e,t){if(nt){for(const n of ct)Pt(n,e,t);nt.startTile.x+=e,nt.startTile.y+=t,nt.endTile.x+=e,nt.endTile.y+=t,Fe(ht(),{isSelection:!0,valid:!0})}}function vt(e){const t=fn.indexOf(e);if(-1===t)throw new Error("Could not find entity to delete in entities array");fn.splice(t,1),e===gn&&Wn(void 0)}function wt(e,t){if(e.segments.length>=2){const n=fn.indexOf(e);if(-1===n)throw new Error("Could not find snake in entities array");const i=e.segments.slice(0,t),o=e.segments.slice(t+1);if(e.segments.length=i.length,o.length>0){const t=new xt;t.segments.length=0,t.segments.push(...o),fn.push(t),0===e.segments.length&&(fn.splice(n,1),e===gn&&Wn(t)),At()}}else vt(e)}class xt extends we{segments=[];fusedSnakeIds=(()=>new Set)();id=(()=>crypto.randomUUID())();growOnNextMove=!1;_highlightTime=-1/0;_melodyIndex=0;_movementPreview={x:0,y:0};_headRelativeOffset={x:0,y:0};_headAngularOffset=0;_tailTravelOffset=0;_tailAnimStartPos=null;_tailAnimFactor=0;_xEyes=!1;static HIGHLIGHT_DURATION=500;static DEBUG_SNAKE_DRAGGING=!1;constructor(){super();for(let e=0;e<10;e++)this.segments.push({x:e,y:0,width:1,height:1,layer:be.White})}toJSON(){const e=Array.from(this.fusedSnakeIds).filter((e=>e!==this.id&&fn.some((t=>t instanceof xt&&t.id===e))));return{id:this.id,segments:this.segments,growOnNextMove:this.growOnNextMove,fusedSnakeIds:e.length?e:void 0}}fromJSON(e){const{id:t,segments:n,growOnNextMove:i,fusedSnakeIds:o}=e;this.id=t,this.segments=n,this.growOnNextMove=i,this.fusedSnakeIds=new Set(o??[])}highlight(){this._highlightTime=performance.now()}previewMovement(e,t){this._movementPreview.x=e,this._movementPreview.y=t;const n=Math.atan2(this._movementPreview.y,this._movementPreview.x),i=Math.hypot(this._movementPreview.y,this._movementPreview.x),o=this.segments.length>1?Math.atan2(this.segments[1].y-this.segments[0].y,this.segments[1].x-this.segments[0].x):Math.PI/2;this._headRelativeOffset={x:Math.cos(n-o)*i,y:Math.sin(n-o)*i},this._headAngularOffset=-1*this._headRelativeOffset.y,this._tailTravelOffset=this._tailAnimFactor*i}draw(e){this._bodyPath(e),e.fillStyle=this.segments[0].layer===be.White?"#fff":"#000",e.fill()}draw2(e){const t=ct.includes(this);this._drawHeadDetails(e),this._drawBodyOutline(e,(()=>{e.strokeStyle=this.segments[0].layer===be.White?"#fff":"#000",e.lineWidth=2*Math.min(.6,Math.max(.1,2/e.getTransform().a)),e.stroke()})),this._drawBodyOutline(e,(()=>{t&&e.setLineDash([.1,.2]),e.strokeStyle=this.segments[0].layer===be.White?"#000":"#fff",e.lineWidth=Math.min(.6,Math.max(.1,2/e.getTransform().a)),e.stroke()}))}draw3(e){const t=performance.now()-this._highlightTime,n=Math.min(1,Math.max(0,1-t/xt.HIGHLIGHT_DURATION));if(n>0&&this._drawBodyOutline(e,(()=>{e.strokeStyle=`hsla(40, 100%, 50%, ${n})`,e.lineWidth=Math.min(1,Math.max(.2,10/e.getTransform().a)),e.stroke()})),xt.DEBUG_SNAKE_DRAGGING){e.font="bold 0.5px sans-serif",e.textAlign="center",e.textBaseline="alphabetic";for(let t=0;t<this.segments.length;t++){const n=this.segments[t];e.fillStyle=`hsl(${360*t/this.segments.length}, 100%, 50%)`;const i=Math.PI/2;e.fillText(t.toString(),n.x+n.width/2+.3*Math.sin(t*i+Math.PI/4),n.y+.7*n.height+.3*Math.cos(t*i+Math.PI/4))}}}_drawBodyOutline(e,t){e.save(),e.save(),this._bodyPath(e),e.resetTransform(),e.rect(0,0,e.canvas.width,e.canvas.height),e.restore(),e.clip("evenodd"),this._bodyPath(e),t(),e.restore()}_drawHeadDetails(e){const t=this.segments[0];e.save(),e.translate(t.x+t.width/2,t.y+t.height/2),e.scale(t.width,t.height);const n=this.segments[1]?Math.atan2(this.segments[1].y-t.y,this.segments[1].x-t.x):Math.PI/2;e.rotate(n+this._headAngularOffset);const i=this.segments[1]?1:2;e.translate(this._headRelativeOffset.x*i,this._headRelativeOffset.y*i),e.beginPath();const o=1/8;this._xEyes?(e.lineWidth=1/12,e.moveTo(-.125,.1),e.lineTo(o,.35),e.moveTo(-.125,.35),e.lineTo(o,.1),e.moveTo(-.125,-.35),e.lineTo(o,-.1),e.moveTo(-.125,-.1),e.lineTo(o,-.35),e.strokeStyle=t.layer===be.White?"#000":"#fff",e.stroke(),e.beginPath()):this.growOnNextMove?(e.lineWidth=1/12,e.arc(-.125/3,.225,o,Math.PI/3,-Math.PI/3,!0),e.strokeStyle=t.layer===be.White?"#000":"#fff",e.stroke(),e.beginPath(),e.arc(-.125/3,-.225,o,Math.PI/3,-Math.PI/3,!0),e.strokeStyle=t.layer===be.White?"#000":"#fff",e.stroke(),e.beginPath()):(e.arc(0,.225,o,0,2*Math.PI,!0),e.arc(0,-.225,o,0,2*Math.PI,!0),e.fillStyle=t.layer===be.White?"#000":"#fff",e.fill());const s=performance.now()-this._highlightTime,r=Math.min(1,Math.max(0,1-s/xt.HIGHLIGHT_DURATION));r>0&&(e.beginPath(),e.translate(-.5,0),e.scale(Math.pow(Math.sin(r),.2),1),e.rotate(Math.sin(performance.now()/50)*Math.PI/8),e.moveTo(0,0),e.translate(-.5,0),e.lineTo(0,0),e.rotate(Math.sin(performance.now()/50-1.5)*Math.PI/8),e.lineTo(-.4,-.2),e.lineTo(0,0),e.lineTo(-.4,.2),e.strokeStyle="#fff",e.globalCompositeOperation="exclusion",e.lineWidth=1/12,e.stroke()),e.restore()}_bodyPath(e){e.beginPath();const t=[];function n(n){n(),t.push({matrix:e.getTransform(),draw(){e.scale(1,-1),n()}})}for(let o=0;o<this.segments.length;o++){const t=this.segments[o];e.save(),e.translate(t.x+t.width/2,t.y+t.height/2);const i=Math.atan2(this.segments[o+1]?.y-t.y,this.segments[o+1]?.x-t.x),s=Math.atan2(t.y-this.segments[o-1]?.y,t.x-this.segments[o-1]?.x);if(0===o)1===this.segments.length?(e.rotate(Math.PI/2),e.arc(this._headRelativeOffset.x,this._headRelativeOffset.y,.5,0,2*Math.PI)):(e.rotate(i),e.scale(1,.9),e.arc(this._headRelativeOffset.x,this._headRelativeOffset.y,.5,Math.PI/2,-Math.PI/2));else if(o===this.segments.length-1){if(e.rotate(s),e.scale(1,.9),n((()=>e.lineTo(-.5,-.5))),this._tailAnimStartPos){const n={x:this._tailAnimStartPos.x+(t.x-this._tailAnimStartPos.x)*(1-this._tailTravelOffset),y:this._tailAnimStartPos.y+(t.y-this._tailAnimStartPos.y)*(1-this._tailTravelOffset)},i={x:t.x+(this.segments[o-1].x-t.x)*(1-this._tailTravelOffset),y:t.y+(this.segments[o-1].y-t.y)*(1-this._tailTravelOffset)};e.restore(),e.save(),e.translate(n.x+t.width/2,n.y+t.height/2);const s=Math.atan2(n.y-i.y,n.x-i.x);e.rotate(s),e.scale(1,.9)}e.lineTo(-.5,-.5);const i=.5,r=0;e.quadraticCurveTo(i*(1-r),-.5,i,0),e.quadraticCurveTo(i*(1-r),.5,-.5,.5)}else e.rotate(s),e.scale(1,.9),n((()=>e.lineTo(-.5,-.5))),n((()=>e.lineTo(.5,-.5)));e.restore()}const i=e.getTransform();for(let o=t.length-1;o>=0;o--)e.setTransform(t[o].matrix),t[o].draw();e.closePath(),e.setTransform(i)}at(e,t,n=!0,i=!0){for(let o=n?0:1;o<this.segments.length-(i?0:1);o++){const n=this.segments[o];if(e===n.x&&t===n.y)return{entity:this,layer:n.layer,segmentIndex:o}}return null}animateMove(e,t){const n=performance.now(),i=()=>{const o=performance.now()-n;if(o>60)return this._tailAnimFactor=0,void this.previewMovement(0,0);const s=(1+Math.min(1,o/60))/2-1;this._tailAnimFactor=1,this._tailAnimStartPos=t,this.previewMovement(e.delta.x*s,e.delta.y*s),requestAnimationFrame(i)};i()}animateInvalidMove(e){const t=performance.now(),n=e.encumbered?230:120,i=()=>{const o=performance.now()-t;if(o>n)return this._tailAnimFactor=0,this._xEyes=!1,void this.previewMovement(0,0);const s=Math.min(1,o/n),r=.08*Math.sin(s*Math.PI);this._xEyes=e.encumbered,this._tailAnimFactor=!e.encumbered&&this.segments.length>1&&(e.to.x!==this.segments[1].x||e.to.y!==this.segments[1].y)?-.3:0,this.segments.length>1?this._tailAnimStartPos={x:this.segments[this.segments.length-1].x+(this.segments[this.segments.length-1].x-this.segments[this.segments.length-2].x),y:this.segments[this.segments.length-1].y+(this.segments[this.segments.length-1].y-this.segments[this.segments.length-2].y),width:this.segments[this.segments.length-1].width,height:this.segments[this.segments.length-1].height}:this._tailAnimStartPos=null,this.previewMovement(e.delta.x*r,e.delta.y*r),requestAnimationFrame(i)};i()}getNextMelodyIndex(){return this._melodyIndex++}}function bt(e,t){return e===t||!(!e||!t)&&e.x===t.x&&e.y===t.y&&e.width===t.width&&e.height===t.height}function kt(e,t){return{x:e.x+t.x*e.width,y:e.y+t.y*e.height,width:e.width,height:e.height}}function St(e){return e.x>=0&&e.y>=0&&e.x+e.width<=mn.width&&e.y+e.height<=mn.height}function Et(e,t){return e.x>=t.x&&e.y>=t.y&&e.x+e.width<=t.x+t.width&&e.y+e.height<=t.y+t.height}function _t(e){return{x:Math.max(0,Math.min(mn.width-e.width,e.x)),y:Math.max(0,Math.min(mn.height-e.height,e.y)),width:e.width,height:e.height}}function*Mt(e,t){const n=Math.abs(t.x-e.x),i=-Math.abs(t.y-e.y),o=e.x<t.x?1:-1,s=e.y<t.y?1:-1;let r=e.x,a=e.y,l=n+i;for(;yield{x:r,y:a},r!==t.x||a!==t.y;){const e=2*l;e>=i&&(l+=i,r+=o),e<=n&&(l+=n,a+=s)}}function*It(e,t){const n=Math.abs(t.x-e.x),i=-Math.abs(t.y-e.y),o=e.x<t.x?1:-1,s=e.y<t.y?1:-1;let r=e.x,a=e.y,l=n+i;for(;yield{x:r,y:a},r!==t.x||a!==t.y;)2*l-i>n-2*l?(l+=i,r+=o):(l+=n,a+=s)}function Tt(e){switch(e){case"Block":return new Ae;case"Snake":return new xt;case"Food":return new Te;case"Inverter":return new qe;case"Crate":return new Re;case"CellularAutomata":return new De;default:throw new Error(`Unknown entity type: ${e}`)}}function At(){fn.sort(((e,t)=>+(e instanceof Ie)-+(t instanceof Ie)))}function Dt(e,t,n={}){const i=[];for(let o=fn.length-1;o>=0;o--){const s=fn[o];if(s instanceof xt){const o=s.at(e,t,!0,s!==n.ignoreTailOfSnake);o&&i.push(o)}else if(s.at){const n=s.at(e,t);n&&i.push(n)}}return i}function Rt(e){for(const t of e)if(t.entity.solid)return t.layer;return be.Black}function Lt(e,t){return!!(e&t)}function Nt(e){return e===be.White?be.Black:e===be.Black?be.White:e}function Ot(){const e=[];return{on:function(t,n,i,o){t.addEventListener(n,i,o),e.push((()=>t.removeEventListener(n,i,o)))},removeEventListeners:function(){for(const t of e)t()}}}function Pt(e,t,n){if(e instanceof Me)e.x+=t,e.y+=n;else if(e instanceof xt)for(const i of e.segments)i.x+=t,i.y+=n}const Ct={Bridge:["Black snakes can go on white, and white snakes can go on black.","Grow the black snake first by collecting the black star.","Make a straight line across for the white snake to cross","Make the bridge in the middle, where it's narrower."],Ferry:["Consider divisibility.","The black snake is 6-long, and so it can fit on two 3-long snakes.","While both 3-long snakes are under the 6-long snake, they can't move, but the 2-long snake can.","Arrange the snakes in a row so that the shortest snake can move from the left to the right while the black snake is in the middle."],"Yin and Yang: Give and Take":["Make a bridge for each color.","The first bridge must make room for the snake to exit.","One way to make the bridges is a 2x2 square."],"Fill The Box":["Avoid creating 1-wide gaps. If there are two dead ends, it's impossible to fill both.","The initial moves of each snake can make it easier.","Construct a Hamiltonian path on a grid graph."],"North Star":["Free the white snake heads so they can form a bridge.","Free the middle white snake head last to let the black snake head get to all of them."],Corkscrew:["Grow the white snake and then cover the black food.","Let the black snake eat all but one of the covered stars.","The remaining star should be on the side, not the middle, so it can be eaten while crossing to the top."],"The Three Pagodas":["The black snake (black chicken in the myth) can turn around when growing from one to two segments","The long white snake can provide a pathway with an exit for the black snake","Get the white food last"],"Lock Picking":["Slide the pins (horizontal white snakes) into the compartment on the right.","The black snake must be facing the right way when bridging the pins","If you do the middle pin first, the top or bottom one can't fit.","The last pin doesn't need to fit in the compartment on the right."],"Yin and Yang: Challenge":["While symmetrical, there is an imbalance.","The black snake has plenty of room to get out of the way if you grow it first.","Bridge the black food, then grow the black snake, then move the black snake around the rim to get it off of the white snake. Finally, bridge the white food and collect all of it.","Avoid creating 1-wide gaps (dead ends) in which food needs to be collected. If you create multiple of these it can become impossible.","You can simplify collecting the white food by removing white boundaries with the black snake, making the area box like or easier to navigate."],"Security by Obscurity":["Don't be fooled by similarity to the prior level...","Think outside the box!"],"Greedy Eyes":["The snakes are greedy, but don't let them eat without setting up for the other snake to move.","Try to free the snake from the upper left fairly early on.","If a snake is too long to get around, maybe have it eat later.","Explore! Don't be afraid to backtrack."],"The Finish Line":["Try to get snakes outside the checker pattern.","Explore! Don't be afraid to backtrack."]},qt=[...document.querySelectorAll("#level-select .level-button")].map((e=>e.textContent.trim()));for(const t in Ct)qt.includes(t)||console.warn(`Level name "${t}" not found on level select screen.`);let Ft,$t=!0;const Bt=new Map;async function Gt(e){return Bt.has(e)||Bt.set(e,fetch(e)),(await Bt.get(e)).clone()}async function zt(e,t){const n=await Gt(e);n.ok?Un(await n.blob(),"play",t,e):alert(`Failed to load level ${JSON.stringify(e)}: ${n.statusText}`)}function jt(e=!0){$t=e,e?(Ft=void 0,document.body.dataset.standaloneLevel=""):delete document.body.dataset.standaloneLevel}function Wt(){return Ft?.getAttribute("data-level")??""}function Kt(){document.title="edit"===xn?"Snakeshift - Level Editor":"replay"===xn?"Snakeshift - Replay":Ft?`Snakeshift - ${Ft.querySelector(".button-text")?.textContent}`:"play"===xn?"Snakeshift - Custom Level":"Snakeshift";for(const o of document.querySelectorAll(".level-specific-overlay, #level-stuck-hint"))o.hidden=o.dataset.forLevel!==Wt();const e=document.querySelector("#hint-button"),t=document.querySelector("#hints-list"),n=document.querySelector("#hints-dialog-next-hint-button"),i=document.querySelector("#hints-dialog");if(t.innerHTML="",e.hidden=!0,Ft){const o=Ft.querySelector(".button-text")?.textContent??"",s=Ct[o];if(s){for(const e of s){const n=document.createElement("li");n.textContent=e,t.append(n),n.classList.add("hint"),n.hidden=!0}e.hidden=!1,i.querySelector(".hint[hidden]")?.removeAttribute("hidden"),n.hidden=!i.querySelector(".hint[hidden]")}else t.innerHTML="<li>No hints available for this level.</li>",n.hidden=!0}}const Vt=location.hash.match(/^#\/?levels\/(.+)$/);Vt&&setTimeout((()=>{const e=document.querySelector(`button[data-level*="${Vt[1]}"]`);e&&e.click()}),100),location.search.includes("show-test-levels")&&(document.querySelector("#test-cases-not-real-levels").hidden=!1);const Ht=document.querySelector("#play-button"),Ut=document.querySelector("#level-select-button"),Jt=document.querySelector("#level-editor-button"),Yt=document.querySelector("#credits-button"),Zt=document.querySelector("#back-to-main-menu-button"),Xt=document.querySelector("#main-menu"),Qt=document.querySelector("#level-select"),en=document.querySelector("#credits"),tn=document.querySelector("#level-splash"),nn=document.querySelector("#level-splash-title");function on(){Ht.addEventListener("click",(()=>{sn(),document.querySelector(".level-button").click()})),Ut.addEventListener("click",(()=>{sn(),Qt.classList.add("active"),function(){for(const e of document.querySelectorAll(".level-button")){const t=e.getAttribute("data-level"),i=Number(n.getItem(Z(t))??1/0),o=n.getItem(Y(t)),s=i<1/0;e.dataset.moveCount=String(i),e.dataset.completed=String(s);let r=e.parentElement.querySelector(".replay-button");if(o&&!r){r=document.createElement("button"),r.className="bw-button replay-button",e.parentElement.append(r),r.addEventListener("click",(()=>{Yn(o,"replay")}));const t=document.createElement("img");t.src="graphics/view-replay-3.svg",t.alt="View Replay",t.width=32,t.height=32,r.append(t)}}}(),document.body.dataset.screen="level-select"})),Jt.addEventListener("click",(()=>{sn(),Qn("edit"),Cn(!1,!0),document.body.dataset.screen="level-editor"})),Yt.addEventListener("click",(()=>{sn(),en.classList.add("active"),document.body.dataset.screen="credits"})),Zt.addEventListener("click",(()=>{"play"===xn&&$t?Qn("edit"):rn()})),rn()}function sn(e={}){for(const t of document.querySelectorAll(".screen.active"))e.except?.includes(t.id)||t.classList.remove("active");e.except?.includes(tn.id)||cn()}function rn(){return!!Jn()&&(sn(),Xt.classList.add("active"),document.body.dataset.screen="main-menu",Qn("menu"),Ht.focus(),!0)}const an=new Set;function ln(e){sn(),tn.classList.add("active"),nn.textContent=e.title,ye("gong"),an.add(setTimeout((()=>{tn.style.transition="opacity .5s",tn.style.opacity="0",an.add(setTimeout((()=>{cn()}),location.search.includes("fast-splash-screens")?0:600))}),location.search.includes("fast-splash-screens")?100:e.duration??2e3))}function cn(){for(const e of an)clearTimeout(e);an.clear(),tn.classList.remove("active"),tn.style.transition="",tn.style.opacity="",nn.textContent=""}function dn(e){const{on:t,removeEventListeners:i}=Ot();function o(){pn===xe.KeyboardFacingRelative||pn===xe.KeyboardAbsoluteDirection&&Be(void 0)}Bn(o),Gn(o);let s,r=!1;if("menu"!==xn){let i,o=!1;const l=e=>{const t=Xe(e),n=Dt(t.x,t.y).find((e=>e.entity instanceof xt));if(n)return n?.entity;let i,o=40;for(const s of fn)if(s instanceof xt)for(const t of s.segments){const n=Qe(t),r={x:n.x+n.width/2,y:n.y+n.height/2},a=Math.hypot(r.x-e.clientX,r.y-e.clientY);a<o&&(i=s,o=a)}return i};t(e,"pointerdown",(e=>{r=!0,s={x:e.clientX,y:e.clientY},jn(xe.Pointer),i=l(e),o=!1})),t(window,"pointerup",(e=>{r=!1,s=void 0,i&&l(e)===i&&!o&&hi()&&(Wn(i),ye("switchSnakes"),i.highlight()),a()})),t(window,"pointercancel",(()=>{r=!1,s=void 0,a()})),t(window,"pointermove",(e=>{if(!(r&&gn&&s&&hi()))return;e.preventDefault();const t=e.clientX-s.x,i=e.clientY-s.y,a=parseInt(n.getItem(J)??"40");if(gn.previewMovement(t/a/10,i/a/10),Math.abs(t)<a&&Math.abs(i)<a)return;let l=0,c=0;if(Math.abs(t)>Math.abs(i)?l=Math.sign(t):c=Math.sign(i),0!==l||0!==c){const t=ii(gn,l,c);t.valid?(si(t),zn(),o=!0,hn(!0)):(gn.animateInvalidMove(t),hn(!1)),0!==l&&(s.x=e.clientX),0!==c&&(s.y=e.clientY)}}))}function a(){for(const e of fn)e instanceof xt&&e.previewMovement(0,0)}function l(e,t,n=xe.KeyboardAbsoluteDirection,i){if(!gn){const n=document.activeElement??document.body,i=n.getBoundingClientRect(),o={x:i.x+i.width/2,y:i.y+i.height/2},s={x:e/Math.hypot(e,t),y:t/Math.hypot(e,t)},r=e=>{const t=e.getBoundingClientRect(),n=t.x+t.width/2,i=t.y+t.height/2,r=n-o.x,a=i-o.y,l=r/Math.hypot(r,a),c=a/Math.hypot(r,a);return s.x*l+s.y*c},a=e=>{const t=e.getBoundingClientRect(),n=t.x+t.width/2,i=t.y+t.height/2,s=n-o.x,r=i-o.y;return Math.hypot(s,r)},l=e=>a(e)/r(e),c=e=>{const t=e.getBoundingClientRect(),n={x:t.x+t.width/2,y:t.y+t.height/2};return e.contains(document.elementFromPoint(n.x,n.y))},d=[...document.querySelectorAll("button, a")].filter((e=>e!==n&&c(e)&&r(e)>0));return d.sort(((e,t)=>l(e)-l(t))),void(d.length&&(console.log("focusing",d[0]),d[0].focus()))}if(!hi())return;const o=ii(gn,e,t);if(!o.valid)return gn.animateInvalidMove(o),jn(n),void hn(!1,i);si(o),jn(n)}t(window,"keydown",(e=>{if(e.ctrlKey||e.metaKey||e.altKey)return;let t=!0;switch(e.code){case"ArrowLeft":case"KeyA":case"Numpad4":case"KeyH":l(-1,0);break;case"ArrowRight":case"KeyD":case"Numpad6":case"KeyL":l(1,0);break;case"ArrowUp":case"KeyW":case"Numpad8":case"KeyK":l(0,-1);break;case"ArrowDown":case"KeyS":case"Numpad2":case"Numpad5":case"KeyJ":l(0,1);break;case"Tab":case"ShiftLeft":case"ShiftRight":"play"===xn?qn():t=!1;break;default:t=!1}t&&e.preventDefault()}));const c=new Map,d=new Map;function h(e,t){const n=c.get(t.index)?.get(e);return t.buttons[e].pressed&&!n}function f(e,t){const i=parseInt(n.getItem(H)??"150"),o=parseInt(n.getItem(U)??"300"),s=performance.now();return h(e,t)?(d.has(t.index)||d.set(t.index,new Map),d.get(t.index).set(e,s+o),!0):!!(t.buttons[e].pressed&&0!==i&&d.has(t.index)&&d.get(t.index).has(e)&&s>=d.get(t.index).get(e))&&(d.get(t.index).set(e,s+i),!0)}const u=setInterval((function(){const e=navigator.getGamepads();let t;for(const n of e){if(!n)continue;let e=!1;if(gn){const[i,o]=n.axes.slice(0,2),s=gn.segments[0],r=Math.hypot(i,o),a=Math.atan2(o,i);let l=Math.round(a/(Math.PI/2));l=(l%ke.length+ke.length)%ke.length;const c=ke[l];if(r>.5){e=!0,t=kt(s,c);const i=ii(gn,c.x,c.y);t&&h(0,n)&&hi()?i.valid?(si(i),jn(xe.Gamepad),t=void 0):(gn.animateInvalidMove(i),jn(xe.Gamepad),t=void 0,hn(!1,n)):jn(xe.Gamepad)}}f(12,n)?l(0,-1,xe.Gamepad,n):f(13,n)?l(0,1,xe.Gamepad,n):f(14,n)?l(-1,0,xe.Gamepad,n):f(15,n)&&l(1,0,xe.Gamepad,n),h(4,n)?qn():h(5,n)&&qn(!0),h(0,n)?gn||document.activeElement instanceof HTMLElement&&document.activeElement.click():h(2,n)?Dn():h(1,n)?Rn():h(3,n)&&ti(),h(8,n)&&rn(),c.set(n.index,new Map(n.buttons.map(((e,t)=>[t,e.pressed]))));for(const t of n.buttons)t.pressed&&(e=!0);e&&jn(xe.Gamepad)}pn===xe.Gamepad&&Be(t)}),1e3/60);return()=>{i(),clearInterval(u)}}function hn(e,t){if("true"===n.getItem(W)){const i=parseInt(n.getItem(e?K:V)??(e?"6":"60"));t?t?.vibrationActuator?.playEffect("dual-rumble",{duration:i,weakMagnitude:.5,strongMagnitude:.3}):navigator.vibrate?.(i)}}const fn=[],un={width:16,height:16},mn={width:un.width,height:un.height};let gn,pn=xe.KeyboardAbsoluteDirection;document.body.dataset.controlScheme=pn;let yn=0;function vn(){yn+=1}let wn,xn="menu",bn=!1,kn=!1;const Sn=[],En=[],_n=[],Mn=[];function In(){Sn.push(On()),En.length=0}let Tn=0,An=0;function Dn(){Ln(Sn,En,!0)&&(ye("undo",{playbackRate:1/(1+Tn/2),cutOffEndFraction:Math.min(.2,Tn/5),volume:.2}),Tn+=1,setTimeout((()=>{Tn-=1}),400),document.getElementById("game-win-screen")?.classList.remove("active"))}function Rn(){Ln(En,Sn)&&(ye("redo",{playbackRate:1+An/10,volume:.2}),An+=1,setTimeout((()=>{An-=1}),400))}function Ln(e,t,n=!1){const i=e.pop();if(!i)return!1;const o=On();return t.push(o),n&&JSON.parse(o).levelId!==JSON.parse(i).levelId?(Ln(e,t),!0):(Pn(i),document.getElementById("replay-slider").value=`${Sn.length}`,!0)}function Nn(e){for(;Sn.length>e&&Ln(Sn,En););for(;Sn.length<e&&Ln(En,Sn););}function On(e=!1){return JSON.stringify({format:"snakeshift",formatVersion:6,levelInfo:mn,entities:fn,entityTypes:fn.map((e=>e.constructor.name)),activePlayerEntityIndex:fn.indexOf(gn),levelId:Wt(),levelSessionId:e?void 0:yn},null,2)+"\n"}function Pn(e,t=null,n=!1){const i=gn?.id??"";fn.length=0;const o=JSON.parse(e);if("snakeshift"!==o.format)throw new Error("Invalid format");if(o.formatVersion>6)throw new Error("Format version is too new");if(1===o.formatVersion){o.formatVersion=2;for(let e=0;e<o.entities.length;e++){const t=o.entities[e];if("Snake"===o.entityTypes[e])for(const e of t.segments)"width"in e||(e.width=e.height=e.size)}}if(2===o.formatVersion&&(o.formatVersion=3,o.levelInfo={width:16,height:16}),3===o.formatVersion){o.formatVersion=4;for(const e of o.entities)delete e._time}if(4===o.formatVersion){o.formatVersion=5;for(let e=0;e<o.entityTypes.length;e++)"Collectable"===o.entityTypes[e]&&(o.entityTypes[e]="Food")}if(5===o.formatVersion){o.formatVersion=6;for(let e=0;e<o.entities.length;e++){const t=o.entities[e];"Food"!==o.entityTypes[e]&&"Inverter"!==o.entityTypes[e]||(delete t._time,delete t.solid)}}if(6!==o.formatVersion)throw new Error("Invalid format version");for(let s=0;s<o.entities.length;s++){const e=o.entities[s],t=Tt(o.entityTypes[s]);t.fromJSON(e),fn.push(t)}mn.width=o.levelInfo.width,mn.height=o.levelInfo.height,gn=fn[o.activePlayerEntityIndex],n||(i===(gn?.id??"")||"play"!=xn&&"replay"!=xn||gn?.highlight(),$t||function(e){e?(Ft=document.querySelector(`button[data-level="${e}"]`)??void 0,$t=!1):jt()}(t||o.levelId),Kt(),zn())}function Cn(e,t){e&&In(),fn.length=0,t&&(mn.width=un.width,mn.height=un.height),gn=void 0,zn()}function qn(e=!1){const t=fn.filter((e=>e instanceof xt)),n=(t.indexOf(gn)+(e?-1:1)+t.length)%t.length;t[n]&&hi()&&(In(),gn=t[n],ye("switchSnakes"),gn.highlight(),zn())}const Fn=[],$n=[];function Bn(e){Fn.push(e)}function Gn(e){$n.push(e)}function zn(){for(const e of Fn)e()}function jn(e){pn=e,document.body.dataset.controlScheme=e,zn()}function Wn(e){gn=e,zn()}function Kn(){if(!gn){const e=fn.filter((e=>e instanceof xt));Wn(e.find((e=>oi(e)))??e[0])}}function Vn(){const e=fn.filter((e=>e instanceof Me&&!St(e))),t=fn.filter((e=>e instanceof xt)).flatMap((e=>e.segments.filter((e=>!St(e)))));if(e.length>0||t.length>0){const n=e.length>0&&t.length>0?" and ":"",i=0===e.length?"":1===e.length?"1 entity":`${e.length} entities`,o=0===t.length?"":1===t.length?"1 snake segment":`${t.length} snake segments`;if(confirm(`Remove ${i}${n}${o} outside the level bounds?`)){In();for(const t of e)fn.splice(fn.indexOf(t),1);for(const e of t){const t=Dt(e.x,e.y);for(const e of t)fn.indexOf(e.entity)>=0&&e.entity instanceof xt&&wt(e.entity,e.segmentIndex)}zn()}}const n=On(!0),i=new Blob([n],{type:"application/json"}),o=URL.createObjectURL(i),s=document.createElement("a");s.href=o,s.download="snakeshift-level.json",s.click()}function Hn(){const e=("replay"===xn?[...Sn,On(),...En.toReversed()]:[...Sn,On()]).map((e=>JSON.parse(e))).filter((e=>e.levelSessionId===yn)).map((e=>(delete e.levelSessionId,e))),t=e[0],n=[];let i=t;const o=q({objectHash:(e,t)=>"id"in e?e.id:"$$index:"+t});for(let s=1;s<e.length;s++){const t=e[s],r=o.diff(i,t);n.push(r),i=t}return JSON.stringify({format:"snakeshift-playthrough",formatVersion:2,baseState:t,deltas:n})}function Un(e,t,n,i=null){e.text().then((e=>{i&&jt(!1),Yn(e,t,i)&&n?.()}),(e=>{alert(`Failed to read level file. ${e}`)}))}function Jn(){if("menu"===xn||"replay"===xn)return!0;if("edit"===xn){if(0===Sn.length&&0===En.length)return!0}else if("play"===xn){if(Wt())return!0;if(0===_n.length&&0===Mn.length)return!0}return confirm("This will discard any unsaved changes. Are you sure?")}function Yn(e,t,n=null){if(!Jn())return!1;const i={state:On(),undos:[...Sn],redos:[...En],levelSessionId:yn};if("play"===xn&&"play"===t&&In(),function(e){const t=e.slice(0,1e3);return!!t.match(/^\s*\[.*snakeshift/s)||!!t.match(/^\s*\{.*"snakeshift-playthrough"/s)}(e)){try{!function(e){const t=B(e);En.length=0,Yn(t[0],"replay");for(const i of t.toReversed())Pn(i),En.push(On());Rn(),Sn.length=0;const n=document.getElementById("replay-slider");n.max=`${t.length}`,n.value="0",n.focus(),ln({title:`Loaded replay with ${t.length} steps`})}(e)}catch(o){return console.error(o),alert(`Failed to load playthrough. ${o.toString()}`),!1}return!0}try{vn(),Pn(e,n),Kn(),ei()}catch(o){return Pn(i.state),Sn.splice(0,Sn.length,...i.undos),En.splice(0,En.length,...i.redos),yn=i.levelSessionId,console.error(o),alert(`Failed to load level. ${o.toString()}`),!1}return Qn(t),sn({except:["level-splash"]}),document.body.dataset.screen="game",!0}function Zn(){const e=document.createElement("input");e.type="file",e.accept="application/json",e.addEventListener("change",(()=>{const t=e.files?.[0];t&&Un(t,"edit")})),e.click()}let Xn=dn(Ge);function Qn(e){xn!==e&&(console.log("Switching from",xn,"to",e),Xn(),xn=e,document.body.classList.toggle("editing","edit"===xn),document.body.classList.toggle("replaying","replay"===xn),"edit"===xn?(jt(),Xn=ut(Ge),wn&&(Sn.splice(0,Sn.length,..._n),En.splice(0,En.length,...Mn),Pn(wn))):"play"===xn||"replay"===xn?("play"===xn&&(Xn=dn(Ge)),_n.splice(0,_n.length,...Sn),Mn.splice(0,Mn.length,...En),kn=fn.some((e=>e instanceof Te)),Sn.length=0,En.length=0,Kn(),ei()):(jt(),Xn=dn(Ge),Cn(!1,!1),Sn.length=0,En.length=0,_n.length=0,Mn.length=0,wn=void 0,kn=!1),bn=!1,Kt())}function ei(){wn=On(),kn=fn.some((e=>e instanceof Te)),bn=!1}function ti(){"replay"!==xn?"play"===xn&&(Wt()?zt(Wt(),(()=>{Kt()})):wn&&(In(),Pn(wn),bn=!1,vn())):Nn(0)}function ni(){Bn((()=>{"play"===xn&&(!bn&&di()?(bn=!0,console.log("Level won!",Wt()),function(){const e=Wt();if(!e)return;const t=Hn(),i=function(e){const t=[],n=B(e).map((e=>{const t=JSON.parse(e),n=[];for(let i=0;i<t.entities.length;i++){const e=t.entities[i],o=t.entityTypes[i];n.push({...e,_type:o})}return{entities:n,activeSnakeId:t.entities[t.activePlayerEntityIndex]?.id}})).filter((({activeSnakeId:e})=>e));let i=null,o=null;for(const a of n){if(i){if(a.activeSnakeId&&o!==a.activeSnakeId){const e=a.entities.find((e=>G(e,"Snake")&&e.id===a.activeSnakeId));if(!e)throw new Error(`Could not find snake with ID ${a.activeSnakeId}`);const n=e.segments[0];t.push({click:n})}for(const e of a.entities)for(const n of i.entities)if(G(e,"Snake")&&G(n,"Snake")&&n.id===e.id){let i=null;if(n.segments[0].x<e.segments[0].x?i="ArrowRight":n.segments[0].x>e.segments[0].x?i="ArrowLeft":n.segments[0].y<e.segments[0].y?i="ArrowDown":n.segments[0].y>e.segments[0].y&&(i="ArrowUp"),i){t.push(i);break}}}i=a,o=a.activeSnakeId}const s=n[n.length-1],r=s.entities.filter((e=>G(e,"Food")));if(1===r.length){const e=r[0],n=s.entities.find((e=>G(e,"Snake")&&e.id===s.activeSnakeId));if(!n)throw new Error(`Could not find snake with ID ${s.activeSnakeId}`);if(!G(e,"Food"))throw new Error("Could not find Food in last state");const i=n.segments[0];i.x<e.x?t.push("ArrowRight"):i.x>e.x?t.push("ArrowLeft"):i.y<e.y?t.push("ArrowDown"):i.y>e.y&&t.push("ArrowUp")}return t}(t).filter((e=>"string"==typeof e)).length,o=Number(n.getItem(Z(e))??1/0);isNaN(o)||i<=o?(console.log("New best move count for level",e,i,"previous best:",o),n.setItem(Z(e),i.toString()),n.setItem(Y(e),t)):console.log("Not a new best move count for level",e,i,"previous best:",o)}(),function(){if(!Ft)return Dn(),ti(),void ln({title:"Level Complete",duration:800});const e=[...document.querySelectorAll(".level-button")],t=e.indexOf(Ft),n=e[t+1];!n||!Ft.closest("#test-cases-not-real-levels")&&n.closest("#test-cases-not-real-levels")?(document.querySelector("#game-win-screen").classList.add("active"),ye("gongBrilliant")):n.click()}()):(di()||(bn=!1),document.querySelector("#level-stuck-hint").hidden=!(kn&&fn.every((e=>!(e instanceof xt&&oi(e)))))))}))}function ii(e,t,n){const i=e.segments[0],o=t*i.width,s=n*i.height,r=i.x+o,a=i.y+s,l=Dt(r,a,{ignoreTailOfSnake:e.growOnNextMove?void 0:e}),c=e.segments.flatMap((e=>Dt(e.x,e.y))).some((t=>t.entity.solid&&t.entity!==e&&fn.indexOf(t.entity)>fn.indexOf(e)&&!(t.entity instanceof xt&&e.fusedSnakeIds.has(t.entity.id)))),d=e.segments.length>1&&t===Math.sign(e.segments[1].x-i.x)&&n===Math.sign(e.segments[1].y-i.y),h=[];{const t=l.find((e=>e.entity.solid));if(t?.entity instanceof Re){const n={x:t.entity.x+o,y:t.entity.y+s,width:t.entity.width,height:t.entity.height},r=Dt(n.x,n.y,{ignoreTailOfSnake:e});if(St(n)&&Lt(t.entity.layer,i.layer)&&!Lt(Rt(r),t.entity.layer)){h.push(t.entity);const e=l.find((e=>e.entity instanceof Ie));e&&h.push(e.entity)}}}for(const f of h){const e=l.findIndex((e=>e.entity===f));-1!==e&&l.splice(e,1)}return{snake:e,valid:(0===t||0===n)&&(1===Math.abs(t)||1===Math.abs(n))&&St({x:r,y:a,width:i.width,height:i.height})&&!d&&!c&&!Lt(Rt(l),i.layer),encumbered:c,to:{x:r,y:a,width:i.width,height:i.height},delta:{x:o,y:s},entitiesThere:l.map((e=>e.entity)),entitiesToPush:h}}function oi(e){return ii(e,1,0).valid||ii(e,0,1).valid||ii(e,-1,0).valid||ii(e,0,-1).valid}function si(e){const t=e.snake,n={...t.segments[t.segments.length-1]};In(),ye("move"),t.growOnNextMove&&(function(e){const t=e.segments[e.segments.length-1],n={...t};e.segments.push(n)}(t),t.growOnNextMove=!1);const i=t.segments[0];for(let c=t.segments.length-1;c>0;c--){const e=t.segments[c],n=t.segments[c-1];e.x=n.x,e.y=n.y}i.x=e.to.x,i.y=e.to.y,i.width=e.to.width,i.height=e.to.height;const o=e.entitiesThere.filter((e=>e.solid)).map((e=>fn.indexOf(e))),s=Math.max(...o),r=fn.indexOf(t);r<s&&(fn.splice(s+1,0,t),fn.splice(r,1)),e.entitiesToPush.length>0&&ye("pushCrate",{playbackRate:.1*Math.random()+.95,volume:.3});for(const c of e.entitiesToPush)Pt(c,e.delta.x,e.delta.y),fn.splice(fn.indexOf(c),1),fn.push(c);e.entitiesToPush.length>0&&At();for(const c of e.entitiesThere)c instanceof Ie&&Lt(c.layer,i.layer)&&!e.entitiesToPush.includes(c)&&(fn.splice(fn.indexOf(c),1),c instanceof Te?(t.growOnNextMove=!0,di()||(a="eat",l=t.getNextMelodyIndex(),ye(a,{playbackRate:ve[l%ve.length]/440}))):c instanceof qe&&li(t));var a,l;for(const c of t.fusedSnakeIds){const e=fn.find((e=>e instanceof xt&&e.id===c));e&&ri(e,e.segments.length-1,t.segments[t.segments.length-1])}!function(){const e=new Map;for(const n of fn)if(n instanceof De){const t=`${n.x},${n.y}`;e.set(t,n)}const t=new Set;for(let n=0;n<mn.height;n++)for(let i=0;i<mn.width;i++){const o=`${i},${n}`;([`${i},${n-1}`,`${i+1},${n}`,`${i},${n+1}`,`${i-1},${n}`].filter((t=>e.get(t)?.layer===Nt(Rt(Dt(i,n).filter((e=>!(e.entity instanceof De))))))).length>=1||e.has(o))&&(Dt(i,n).some((e=>!(e.entity instanceof Ae||e.entity instanceof De)))||t.add(o))}for(let n=fn.length-1;n>=0;n--){const e=fn[n];if(e instanceof De){const i=`${e.x},${e.y}`;if(t.has(i))continue;Dt(e.x,e.y).some((e=>!(e.entity instanceof Ae||e.entity instanceof De)))||fn.splice(n,1)}}for(const n of t){if(e.has(n))continue;const[t,i]=n.split(",").map(Number),o=new De;o.x=t,o.y=i,o.layer=Nt(Rt(Dt(t,i))),fn.push(o)}}(),t.animateMove(e,n)}function ri(e,t,n){const i=e.segments[t];if(i.x!==n.x||i.y!==n.y){const o={x:i.x,y:i.y};for(const s of[...It(o,n)].slice(1)){for(let n=e.segments.length-1;n>t;n--)ai(e.segments[n-1],e.segments[n]);for(let n=0;n<t;n++)ai(e.segments[n+1],e.segments[n]);i.x=s.x,i.y=s.y}}}function ai(e,t){t.x=e.x,t.y=e.y,t.width=e.width,t.height=e.height}function li(e){const t=new Set,n=new Set;function i(e){if(!t.has(e))if(t.add(e),e instanceof Me)e.layer=Nt(e.layer);else if(e instanceof xt)for(const t of e.segments)o(t.x,t.y),t.layer=Nt(t.layer)}function o(e,t){if(n.has(`${e},${t}`))return;n.add(`${e},${t}`);const o=Dt(e,t);for(const n of o)i(n.entity)}i(e);for(const s of n){const[e,t]=s.split(",").map(Number);if(!Dt(e,t).some((e=>e.entity instanceof Ae))){const n=new Ae;n.layer=be.White,n.x=e,n.y=t,fn.unshift(n)}}}function ci(e=0){requestAnimationFrame(ci),function(e){for(const t of fn)t.step?.(e)}(e),He()}function di(){return window._winLevelCheat?(window._winLevelCheat=!1,!0):kn?0===fn.filter((e=>e instanceof Te)).length:(console.log("No goal; level is unwinnable."),!1)}function hi(){return!document.querySelector("#game-win-screen.active, #level-splash.active.active")||parseFloat(getComputedStyle(document.querySelector("#game-win-screen.active, #level-splash.active")).opacity)<.7}var fi=window.CustomEvent;function ui(e,t){var n="on"+t.type.toLowerCase();return"function"==typeof e[n]&&e[n](t),e.dispatchEvent(t)}function mi(e){for(;e;){if("dialog"===e.localName)return e;e=e.parentElement?e.parentElement:e.parentNode?e.parentNode.host:null}return null}function gi(e){for(;e&&e.shadowRoot&&e.shadowRoot.activeElement;)e=e.shadowRoot.activeElement;e&&e.blur&&e!==document.body&&e.blur()}function pi(e,t){for(var n=0;n<e.length;++n)if(e[n]===t)return!0;return!1}function yi(e){return!(!e||!e.hasAttribute("method"))&&"dialog"===e.getAttribute("method").toLowerCase()}function vi(e){var t=["button","input","keygen","select","textarea"].map((function(e){return e+":not([disabled])"}));t.push('[tabindex]:not([disabled]):not([tabindex=""])');var n=e.querySelector(t.join(", "));if(!n&&"attachShadow"in Element.prototype)for(var i=e.querySelectorAll("*"),o=0;o<i.length&&!(i[o].tagName&&i[o].shadowRoot&&(n=vi(i[o].shadowRoot)));o++);return n}function wi(e){return e.isConnected||document.body.contains(e)}function xi(e){if(e.submitter)return e.submitter;var t=e.target;if(!(t instanceof HTMLFormElement))return null;var n=Si.formSubmitter;if(!n){var i=e.target;n=("getRootNode"in i&&i.getRootNode()||document).activeElement}return n&&n.form===t?n:null}function bi(e){if(!e.defaultPrevented){var t=e.target,n=Si.imagemapUseValue,i=xi(e);null===n&&i&&(n=i.value);var o=mi(t);o&&"dialog"===(i&&i.getAttribute("formmethod")||t.getAttribute("method"))&&(e.preventDefault(),null!=n?o.close(n):o.close())}}function ki(e){if(this.dialog_=e,this.replacedStyleTop_=!1,this.openAsModal_=!1,e.hasAttribute("role")||e.setAttribute("role","dialog"),e.show=this.show.bind(this),e.showModal=this.showModal.bind(this),e.close=this.close.bind(this),e.addEventListener("submit",bi,!1),"returnValue"in e||(e.returnValue=""),"MutationObserver"in window)new MutationObserver(this.maybeHideModal.bind(this)).observe(e,{attributes:!0,attributeFilter:["open"]});else{var t,n=!1,i=function(){n?this.downgradeModal():this.maybeHideModal(),n=!1}.bind(this),o=function(o){if(o.target===e){var s="DOMNodeRemoved";n|=o.type.substr(0,14)===s,window.clearTimeout(t),t=window.setTimeout(i,0)}};["DOMAttrModified","DOMNodeRemoved","DOMNodeRemovedFromDocument"].forEach((function(t){e.addEventListener(t,o)}))}Object.defineProperty(e,"open",{set:this.setOpen.bind(this),get:e.hasAttribute.bind(e,"open")}),this.backdrop_=document.createElement("div"),this.backdrop_.className="backdrop",this.backdrop_.addEventListener("mouseup",this.backdropMouseEvent_.bind(this)),this.backdrop_.addEventListener("mousedown",this.backdropMouseEvent_.bind(this)),this.backdrop_.addEventListener("click",this.backdropMouseEvent_.bind(this))}fi&&"object"!=typeof fi||((fi=function(e,t){t=t||{};var n=document.createEvent("CustomEvent");return n.initCustomEvent(e,!!t.bubbles,!!t.cancelable,t.detail||null),n}).prototype=window.Event.prototype),ki.prototype={get dialog(){return this.dialog_},maybeHideModal:function(){this.dialog_.hasAttribute("open")&&wi(this.dialog_)||this.downgradeModal()},downgradeModal:function(){this.openAsModal_&&(this.openAsModal_=!1,this.dialog_.style.zIndex="",this.replacedStyleTop_&&(this.dialog_.style.top="",this.replacedStyleTop_=!1),this.backdrop_.parentNode&&this.backdrop_.parentNode.removeChild(this.backdrop_),Si.dm.removeDialog(this))},setOpen:function(e){e?this.dialog_.hasAttribute("open")||this.dialog_.setAttribute("open",""):(this.dialog_.removeAttribute("open"),this.maybeHideModal())},backdropMouseEvent_:function(e){if(this.dialog_.hasAttribute("tabindex"))this.dialog_.focus();else{var t=document.createElement("div");this.dialog_.insertBefore(t,this.dialog_.firstChild),t.tabIndex=-1,t.focus(),this.dialog_.removeChild(t)}var n=document.createEvent("MouseEvents");n.initMouseEvent(e.type,e.bubbles,e.cancelable,window,e.detail,e.screenX,e.screenY,e.clientX,e.clientY,e.ctrlKey,e.altKey,e.shiftKey,e.metaKey,e.button,e.relatedTarget),this.dialog_.dispatchEvent(n),e.stopPropagation()},focus_:function(){var e=this.dialog_.querySelector("[autofocus]:not([disabled])");!e&&this.dialog_.tabIndex>=0&&(e=this.dialog_),e||(e=vi(this.dialog_)),gi(document.activeElement),e&&e.focus()},updateZIndex:function(e,t){if(e<t)throw new Error("dialogZ should never be < backdropZ");this.dialog_.style.zIndex=e,this.backdrop_.style.zIndex=t},show:function(){this.dialog_.open||(this.setOpen(!0),this.focus_())},showModal:function(){if(this.dialog_.hasAttribute("open"))throw new Error("Failed to execute 'showModal' on dialog: The element is already open, and therefore cannot be opened modally.");if(!wi(this.dialog_))throw new Error("Failed to execute 'showModal' on dialog: The element is not in a Document.");if(!Si.dm.pushDialog(this))throw new Error("Failed to execute 'showModal' on dialog: There are too many open modal dialogs.");(function(e){for(;e&&e!==document.body;){var t=window.getComputedStyle(e),n=function(e,n){return!(void 0===t[e]||t[e]===n)};if(t.opacity<1||n("zIndex","auto")||n("transform","none")||n("mixBlendMode","normal")||n("filter","none")||n("perspective","none")||"isolate"===t.isolation||"fixed"===t.position||"touch"===t.webkitOverflowScrolling)return!0;e=e.parentElement}return!1})(this.dialog_.parentElement)&&console.warn("A dialog is being shown inside a stacking context. This may cause it to be unusable. For more information, see this link: https://github.com/GoogleChrome/dialog-polyfill/#stacking-context"),this.setOpen(!0),this.openAsModal_=!0,Si.needsCentering(this.dialog_)?(Si.reposition(this.dialog_),this.replacedStyleTop_=!0):this.replacedStyleTop_=!1,this.dialog_.parentNode.insertBefore(this.backdrop_,this.dialog_.nextSibling),this.focus_()},close:function(e){if(!this.dialog_.hasAttribute("open"))throw new Error("Failed to execute 'close' on dialog: The element does not have an 'open' attribute, and therefore cannot be closed.");this.setOpen(!1),void 0!==e&&(this.dialog_.returnValue=e);var t=new fi("close",{bubbles:!1,cancelable:!1});ui(this.dialog_,t)}};var Si={reposition:function(e){var t=document.body.scrollTop||document.documentElement.scrollTop,n=t+(window.innerHeight-e.offsetHeight)/2;e.style.top=Math.max(t,n)+"px"},isInlinePositionSetByStylesheet:function(e){for(var t=0;t<document.styleSheets.length;++t){var n=document.styleSheets[t],i=null;try{i=n.cssRules}catch(c){}if(i)for(var o=0;o<i.length;++o){var s=i[o],r=null;try{r=document.querySelectorAll(s.selectorText)}catch(c){}if(r&&pi(r,e)){var a=s.style.getPropertyValue("top"),l=s.style.getPropertyValue("bottom");if(a&&"auto"!==a||l&&"auto"!==l)return!0}}}return!1},needsCentering:function(e){return!("absolute"!==window.getComputedStyle(e).position||"auto"!==e.style.top&&""!==e.style.top||"auto"!==e.style.bottom&&""!==e.style.bottom||Si.isInlinePositionSetByStylesheet(e))},forceRegisterDialog:function(e){if((window.HTMLDialogElement||e.showModal)&&console.warn("This browser already supports <dialog>, the polyfill may not work correctly",e),"dialog"!==e.localName)throw new Error("Failed to register dialog: The element is not a dialog.");new ki(e)},registerDialog:function(e){e.showModal||Si.forceRegisterDialog(e)},DialogManager:function(){this.pendingDialogStack=[];var e=this.checkDOM_.bind(this);this.overlay=document.createElement("div"),this.overlay.className="_dialog_overlay",this.overlay.addEventListener("click",function(t){this.forwardTab_=void 0,t.stopPropagation(),e([])}.bind(this)),this.handleKey_=this.handleKey_.bind(this),this.handleFocus_=this.handleFocus_.bind(this),this.zIndexLow_=1e5,this.zIndexHigh_=100150,this.forwardTab_=void 0,"MutationObserver"in window&&(this.mo_=new MutationObserver((function(t){var n=[];t.forEach((function(e){for(var t,i=0;t=e.removedNodes[i];++i)t instanceof Element&&("dialog"===t.localName&&n.push(t),n=n.concat(t.querySelectorAll("dialog")))})),n.length&&e(n)})))}};if(Si.DialogManager.prototype.blockDocument=function(){document.documentElement.addEventListener("focus",this.handleFocus_,!0),document.addEventListener("keydown",this.handleKey_),this.mo_&&this.mo_.observe(document,{childList:!0,subtree:!0})},Si.DialogManager.prototype.unblockDocument=function(){document.documentElement.removeEventListener("focus",this.handleFocus_,!0),document.removeEventListener("keydown",this.handleKey_),this.mo_&&this.mo_.disconnect()},Si.DialogManager.prototype.updateStacking=function(){for(var e,t=this.zIndexHigh_,n=0;e=this.pendingDialogStack[n];++n)e.updateZIndex(--t,--t),0===n&&(this.overlay.style.zIndex=--t);var i=this.pendingDialogStack[0];i?(i.dialog.parentNode||document.body).appendChild(this.overlay):this.overlay.parentNode&&this.overlay.parentNode.removeChild(this.overlay)},Si.DialogManager.prototype.containedByTopDialog_=function(e){for(;e=mi(e);){for(var t,n=0;t=this.pendingDialogStack[n];++n)if(t.dialog===e)return 0===n;e=e.parentElement}return!1},Si.DialogManager.prototype.handleFocus_=function(e){var t=e.composedPath?e.composedPath()[0]:e.target;if(!this.containedByTopDialog_(t)&&document.activeElement!==document.documentElement&&(e.preventDefault(),e.stopPropagation(),gi(t),void 0!==this.forwardTab_)){var n=this.pendingDialogStack[0];return n.dialog.compareDocumentPosition(t)&Node.DOCUMENT_POSITION_PRECEDING&&(this.forwardTab_?n.focus_():t!==document.documentElement&&document.documentElement.focus()),!1}},Si.DialogManager.prototype.handleKey_=function(e){if(this.forwardTab_=void 0,27===e.keyCode){e.preventDefault(),e.stopPropagation();var t=new fi("cancel",{bubbles:!1,cancelable:!0}),n=this.pendingDialogStack[0];n&&ui(n.dialog,t)&&n.dialog.close()}else 9===e.keyCode&&(this.forwardTab_=!e.shiftKey)},Si.DialogManager.prototype.checkDOM_=function(e){this.pendingDialogStack.slice().forEach((function(t){-1!==e.indexOf(t.dialog)?t.downgradeModal():t.maybeHideModal()}))},Si.DialogManager.prototype.pushDialog=function(e){var t=(this.zIndexHigh_-this.zIndexLow_)/2-1;return!(this.pendingDialogStack.length>=t||(1===this.pendingDialogStack.unshift(e)&&this.blockDocument(),this.updateStacking(),0))},Si.DialogManager.prototype.removeDialog=function(e){var t=this.pendingDialogStack.indexOf(e);-1!==t&&(this.pendingDialogStack.splice(t,1),0===this.pendingDialogStack.length&&this.unblockDocument(),this.updateStacking())},Si.dm=new Si.DialogManager,Si.formSubmitter=null,Si.imagemapUseValue=null,void 0===window.HTMLDialogElement){var Ei=document.createElement("form");if(Ei.setAttribute("method","dialog"),"dialog"!==Ei.method){var _i=Object.getOwnPropertyDescriptor(HTMLFormElement.prototype,"method");if(_i){var Mi=_i.get;_i.get=function(){return yi(this)?"dialog":Mi.call(this)};var Ii=_i.set;_i.set=function(e){return"string"==typeof e&&"dialog"===e.toLowerCase()?this.setAttribute("method",e):Ii.call(this,e)},Object.defineProperty(HTMLFormElement.prototype,"method",_i)}}document.addEventListener("click",(function(e){if(Si.formSubmitter=null,Si.imagemapUseValue=null,!e.defaultPrevented){var t=e.target;if("composedPath"in e&&(t=e.composedPath().shift()||t),t&&yi(t.form)){if(!("submit"===t.type&&["button","input"].indexOf(t.localName)>-1)){if("input"!==t.localName||"image"!==t.type)return;Si.imagemapUseValue=e.offsetX+","+e.offsetY}mi(t)&&(Si.formSubmitter=t)}}}),!1),document.addEventListener("submit",(function(e){var t=e.target;if(!mi(t)){var n=xi(e);"dialog"===(n&&n.getAttribute("formmethod")||t.getAttribute("method"))&&e.preventDefault()}}));var Ti=HTMLFormElement.prototype.submit;HTMLFormElement.prototype.submit=function(){if(!yi(this))return Ti.call(this);var e=mi(this);e&&e.close()}}
/*!
       * fullscreen-polyfill
       * 1.0.4 - 12/2/2020
       * https://github.com/nguyenj/fullscreen-polyfill#readme
       * (c) John Nguyen; MIT License
       */!function(){var e=["fullscreen","fullscreenEnabled","fullscreenElement","fullscreenchange","fullscreenerror","exitFullscreen","requestFullscreen"],t=["webkitIsFullScreen","webkitFullscreenEnabled","webkitFullscreenElement","webkitfullscreenchange","webkitfullscreenerror","webkitExitFullscreen","webkitRequestFullscreen"],n=["mozFullScreen","mozFullScreenEnabled","mozFullScreenElement","mozfullscreenchange","mozfullscreenerror","mozCancelFullScreen","mozRequestFullScreen"],i=["","msFullscreenEnabled","msFullscreenElement","MSFullscreenChange","MSFullscreenError","msExitFullscreen","msRequestFullscreen"];document||(document={});var o,s=(o=[e[1],t[1],n[1],i[1]].find((function(e){return document[e]})),[e,t,n,i].find((function(e){return e.find((function(e){return e===o}))}))||[]);function r(t,n){document[e[0]]=document[s[0]]||!!document[s[2]]||!1,document[e[1]]=document[s[1]]||!1,document[e[2]]=document[s[2]]||null,document.dispatchEvent(new Event(t),n.target)}void 0===document[e[1]]&&s.length&&(document[e[0]]=document[s[0]]||!!document[s[2]]||!1,document[e[1]]=document[s[1]]||!1,document[e[2]]=document[s[2]]||null,document.addEventListener(s[3],r.bind(document,e[3]),!1),document.addEventListener(s[4],r.bind(document,e[4]),!1),document[e[5]]=function(){return document[s[5]]()},Element.prototype[e[6]]=function(){return this[s[6]].apply(this,arguments)})}();const Ai=[document.querySelector("#hints-dialog"),document.querySelector("#settings-dialog"),document.querySelector("#level-info-editor")];for(const t of Ai)Si.registerDialog(t);let Di=1;function Ri(e){return{snakeId:e.snake.id,delta:e.delta}}function Li(e){return ii(fn.find((t=>t instanceof xt&&t.id===e.snakeId)),e.delta.x,e.delta.y)}window.crypto.randomUUID??=()=>"fake polyfilled randomUUID: "+(Di++).toString();const Ni={tileOnPage:Qe,playedSounds:Q,serialize:On,deserialize:Pn,loadLevelFromText:Yn,serializePlaythrough:Hn,solvePuzzle:function(e=50){const t=new Set,n=[];return async function i(o=0){if(o>e)return!1;const s=On();if(t.has(s))return!1;if(t.add(s),di())return n;for(const e of function(){const e=[];for(const t of fn)if(t instanceof xt)for(const n of ke){const i=ii(t,n.x,n.y);i.valid&&e.push(Ri(i))}return e}()){if(si(Li(e)),n.push(e),await new Promise((e=>setTimeout(e,0))),await i(o+1))return n;Dn(),n.pop()}return!1}()}};window._forTesting=Ni;const Oi=document.querySelector("#play-edit-toggle-button"),Pi=document.querySelector("#restart-level-button"),Ci=document.querySelector("#undo-button"),qi=document.querySelector("#redo-button"),Fi=document.getElementById("fullscreen-button"),$i=document.getElementById("replay-slider"),Bi=document.querySelector("#hint-button"),Gi=document.querySelector("#hints-dialog"),zi=document.querySelector("#hints-dialog-ok-button"),ji=document.querySelector("#hints-dialog-next-hint-button"),Wi=document.querySelector("#settings-button"),Ki=document.querySelector("#settings-dialog"),Vi=document.querySelector("#settings-dialog-ok-button"),Hi=document.querySelector("#settings-dialog-cancel-button"),Ui=Ki.querySelector("#settings-haptics-enabled"),Ji=Ki.querySelector("#settings-haptics-valid-move-ms"),Yi=Ki.querySelector("#settings-haptics-invalid-move-ms"),Zi=Ki.querySelector("#settings-gamepad-repeat-rate"),Xi=Ki.querySelector("#settings-gamepad-repeat-delay"),Qi=Ki.querySelector("#settings-pointer-move-threshold");function eo(){Ji.disabled=!Ui.checked,Yi.disabled=!Ui.checked;for(const e of document.querySelectorAll(".enabled-by-haptics"))e.classList.toggle("disabled",!Ui.checked)}function to(){document.fullscreenElement?document.exitFullscreen():document.documentElement.requestFullscreen()}function no(e,t){const i=n.getItem(Z(e)),o=n.getItem(Y(e));i&&n.setItem(Z(t),i),o&&n.setItem(Y(t),o),n.removeItem(Z(e)),n.removeItem(Y(e))}Oi.addEventListener("click",(()=>{Qn("play"===xn?"edit":"play")})),Pi.addEventListener("click",ti),Ci.addEventListener("click",Dn),qi.addEventListener("click",Rn),Fi.addEventListener("click",to),Bi.addEventListener("click",(()=>{Gi.showModal();const e=Gi.querySelector("input, textarea");e?.focus(),e?.select?.()})),zi.addEventListener("click",(e=>{e.preventDefault(),Gi.close()})),ji.addEventListener("click",(e=>{e.preventDefault(),Gi.querySelector(".hint[hidden]")?.removeAttribute("hidden"),ji.hidden=!Gi.querySelector(".hint[hidden]")})),Ui.addEventListener("change",eo),Wi.addEventListener("click",(()=>{Ki.showModal(),Ui.checked="true"===n.getItem(W),Ji.value=n.getItem(K)??"6",Yi.value=n.getItem(V)??"60",Zi.value=n.getItem(H)??"150",Xi.value=n.getItem(U)??"300",Qi.value=n.getItem(J)??"40";const e=Ki.querySelector("input, textarea");e?.focus(),e?.select?.(),eo()})),Ki.addEventListener("close",(()=>{console.log(Ki.returnValue)})),Ki.addEventListener("keydown",(e=>{"Escape"===e.key&&Ki.close(),e.stopPropagation()})),Vi.addEventListener("click",(e=>{e.preventDefault();const t=parseInt(Ji.value),i=parseInt(Yi.value),o=parseInt(Zi.value),s=parseInt(Xi.value),r=parseInt(Qi.value);isNaN(t)||isNaN(i)||isNaN(o)||isNaN(s)||isNaN(r)?alert("Invalid input. Please enter a number."):([n.setItem(W,Ui.checked?"true":"false"),n.setItem(K,t.toString()),n.setItem(V,i.toString()),n.setItem(H,o.toString()),n.setItem(U,s.toString()),n.setItem(J,r.toString())].every(Boolean)||(console.error("Failed to save settings to local storage"),alert("Failed to save settings. Make sure cookies are enabled and try again.")),Ki.close())})),Hi.addEventListener("click",(e=>{e.preventDefault(),Ki.close()})),$i.addEventListener("input",(()=>{Nn(parseInt($i.value))})),addEventListener("keydown",(e=>{if(hi()||"z"===e.key||"Z"===e.key||"y"===e.key){if(","===e.key)Wi.click(),e.preventDefault();else if("`"!==e.key||e.repeat)if("z"===e.key||"Z"===e.key)e.shiftKey?Rn():Dn(),e.preventDefault();else if("y"===e.key)Rn(),e.preventDefault();else if("r"===e.key)ti(),e.preventDefault();else if("p"===e.key)!function(){const e=Hn(),t=new Blob([e],{type:"application/json"}),n=URL.createObjectURL(t),i=document.createElement("a");i.href=n,i.download="snakeshift-level-playthrough.json",i.click()}(),e.preventDefault();else if("s"===e.key&&(e.ctrlKey||e.metaKey))Vn(),e.preventDefault();else if("o"===e.key&&(e.ctrlKey||e.metaKey))Zn(),e.preventDefault();else if("n"===e.key&&"edit"==xn)Cn(!0,!1),e.preventDefault();else if("a"===e.key&&"edit"==xn)dt(),ct=[...fn],nt={startTile:{x:0,y:0,width:1,height:1},endTile:{x:mn.width-1,y:mn.height-1,width:1,height:1},defining:!1},Fe(ht(),{isSelection:!0,valid:!0}),zn(),e.preventDefault();else if("Delete"===e.key&&"edit"==xn)mt(),e.preventDefault();else if("i"===e.key&&"edit"==xn)gt(),e.preventDefault();else if("c"===e.key&&"edit"==xn)pt(),e.preventDefault();else if("x"===e.key&&"edit"==xn)!async function(){await pt(),mt()}(),e.preventDefault();else if("v"===e.key&&"edit"==xn)!async function(){let e;try{e=await navigator.clipboard.readText()}catch(n){return void alert(`Error pasting: ${String(n)}`)}const t=On();try{Pn(e);for(const e of fn)"id"in e&&(e.id=crypto.randomUUID());nt={startTile:{x:0,y:0,width:1,height:1},endTile:{x:mn.width-1,y:mn.height-1,width:1,height:1},defining:!1},ct=[...fn]}catch(n){alert(`Error pasting: ${String(n)}`)}finally{Pn(t)}In(),fn.splice(0,0,...ct),At(),zn()}(),e.preventDefault();else if("e"===e.key&&e.altKey&&"edit"==xn)document.querySelector("#level-info-button").click(),e.preventDefault();else if("ArrowLeft"!==e.key&&"ArrowRight"!==e.key&&"ArrowUp"!==e.key&&"ArrowDown"!==e.key||"edit"!=xn)"Escape"===e.key?(document.querySelector("#back-to-main-menu-button").click(),e.preventDefault()):"m"===e.key?(ue(),e.preventDefault()):"f"===e.key&&(to(),e.preventDefault());else{const t="ArrowRight"===e.key?1:"ArrowLeft"===e.key?-1:0,n="ArrowDown"===e.key?1:"ArrowUp"===e.key?-1:0;In(),yt(t,n),e.preventDefault()}else"play"===xn?Qn("edit"):"edit"===xn&&Qn("play"),e.preventDefault();fe()}else e.shiftKey||e.ctrlKey||e.altKey||e.metaKey||e.repeat||"Enter"!==e.key&&" "!==e.key&&"Escape"!==e.key||(document.querySelector("#game-win-screen")?.classList.contains("active")?rn():cn(),e.preventDefault())})),Ge.addEventListener("pointerdown",(e=>{e.preventDefault(),window.getSelection()?.removeAllRanges()})),window.addEventListener("pointerdown",(e=>{fe(),"touch"===e.pointerType&&jn(xe.Pointer)})),Ge.addEventListener("contextmenu",(e=>{e.preventDefault()})),addEventListener("dragover",(e=>{e.preventDefault()})),addEventListener("drop",(e=>{e.preventDefault();const t=e.dataTransfer?.files[0];t&&Un(t,"edit")})),async function(){await Ee,await Ne,function(){let e=Number(n.getItem(X)??2);e>2&&console.error("Saved local storage format version is newer than this version of the game. Some data may be lost."),1===e&&(e=2,no("levels/easy/002-bridge.json","levels/easy/003-bridge.json"),no("levels/easy/003-ferry.json","levels/easy/004-ferry.json"),no("levels/easy/004-yin-yang-give-and-take.json","levels/easy/005-yin-yang-give-and-take.json"),no("levels/easy/005-fill-the-box-further-too-many-solutions.json","levels/easy/006-fill-the-box-further-too-many-solutions.json"),no("levels/easy/006-north-star.json","levels/easy/007-north-star.json"),n.setItem(X,String(e))),2!==e?console.error("Invalid local storage format version."):n.setItem(X,2..toString())}(),ni(),on(),ft(),function(){const e=document.querySelectorAll(".level-button");for(const t of e){const e=document.createElement("div");e.className="level-button-wrapper",t.replaceWith(e),e.append(t);const n=t.getAttribute("data-level");t.addEventListener("click",(()=>{ln({title:t.querySelector(".button-text")?.textContent??"Loading..."}),zt(n,(()=>{Ft=t,$t=!1,Kt()}))}));const i=document.createElement("span");i.className="button-text",i.textContent=t.textContent.trim(),t.textContent="",t.append(i);const o=document.createElement("div");o.className="level-preview";const s=document.createElement("div");s.className="level-preview-error",s.hidden=!0;const r=document.createElement("canvas"),a=r.getContext("2d");t.prepend(o),o.append(r,s);const l=200,c=200;(async()=>{if(location.search.includes("no-level-previews"))return;r.style.width=`${l}px`,r.style.height=`${c}px`;const e=Math.floor(l*devicePixelRatio),t=Math.floor(c*devicePixelRatio);(r.width!==e||r.height!==t)&&(r.width=e,r.height=t),a.fillStyle="#000",a.fillRect(0,0,r.width,r.height);const i=await Gt(n);if(!i.ok)return s.textContent=`Failed to load level preview.\nStatus: ${i.statusText}`,void(s.hidden=!1);const o=await i.blob(),d=await o.text(),h=On();try{Pn(d,n,!0),a.save(),a.translate(r.width/2,r.height/2);const e=.2,t=mn.width+2*e,i=mn.height+2*e,o=mn.width/2,s=mn.height/2,l=Math.min(r.width/t,r.height/i);a.scale(l,l),a.translate(-o,-s),Ue(a,fn),a.restore()}catch(f){s.textContent=`Failed to load level preview.\n${String(f)}`,s.hidden=!1}finally{Pn(h)}})()}}(),Object.assign(ae,await(async e=>{const t=Object.entries(e);let n=!1;return Object.fromEntries(await Promise.all(t.map((async([e,t])=>{let i;try{i=await ge(t)}catch(o){n||("file:"===location.protocol?(pe("This page must be served by a web server,\nin order to load files needed for the game.",o),n=!0):pe(`Failed to load resource '${t}'`,o))}if(de+=1,de/ce*14>he.length){const e=document.createElement("div");e.classList.add("load-progress-brick"),he.push(e),ne.appendChild(e)}return[e,i]}))))})(le)),ci()}().catch((e=>{console.error("Error during initialization:",e),alert("An error occurred during initialization. Please try reloading the page.\n\n"+e)}))}}}));
